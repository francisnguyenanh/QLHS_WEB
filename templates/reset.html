{% extends "base.html" %}
{% block title %}X√≥a D·ªØ Li·ªáu{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        X√≥a To√†n B·ªô D·ªØ Li·ªáu H·ªá Th·ªëng
                    </h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>C·∫£nh b√°o:</strong> Ch·ª©c nƒÉng n√†y s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu trong h·ªá th·ªëng theo th·ª© t·ª± sau:
                    </div>
                    
                    <div class="mb-4">
                        <h5>Danh s√°ch b·∫£ng s·∫Ω ƒë∆∞·ª£c x√≥a:</h5>
                        <ol class="list-group list-group-numbered">
                            <li class="list-group-item">D·ªØ li·ªáu h·∫°nh ki·ªÉm h·ªçc sinh</li>
                            <li class="list-group-item">D·ªØ li·ªáu h·ªçc t·∫≠p h·ªçc sinh</li>
                            <li class="list-group-item">D·ªØ li·ªáu ph√¢n quy·ªÅn ch·ª©c v·ª•</li>
                            <li class="list-group-item">D·ªØ li·ªáu ng∆∞·ªùi d√πng</li>
                        </ol>
                    </div>

                    <div class="alert alert-danger">
                        <i class="fas fa-skull-crossbones"></i>
                        <strong>L∆ØU √ù QUAN TR·ªåNG:</strong>
                        <ul class="mb-0 mt-2">
                            <li>H√†nh ƒë·ªông n√†y <strong>KH√îNG TH·ªÇ HO√ÄN T√ÅC</strong></li>
                            <li>T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn</li>
                            <li>Ch·ªâ t√†i kho·∫£n Master m·ªõi c√≥ quy·ªÅn th·ª±c hi·ªán</li>
                            <li>H√£y ƒë·∫£m b·∫£o ƒë√£ sao l∆∞u d·ªØ li·ªáu tr∆∞·ªõc khi th·ª±c hi·ªán</li>
                        </ul>
                    </div>

                    <div class="d-flex justify-content-center mt-4">
                        <button type="button" class="btn btn-danger btn-lg" id="resetAllBtn">
                            <i class="fas fa-trash-alt"></i>
                            X√≥a To√†n B·ªô D·ªØ Li·ªáu
                        </button>
                    </div>

                    <!-- Progress indicator -->
                    <div id="progressContainer" class="mt-4" style="display: none;">
                        <h6>Ti·∫øn tr√¨nh x√≥a d·ªØ li·ªáu:</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>
                        <div id="progressText" class="small text-muted"></div>
                        <div id="logContainer" class="mt-3">
                            <div class="alert alert-info">
                                <div id="logMessages"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    X√°c Nh·∫≠n X√≥a D·ªØ Li·ªáu
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-skull-crossbones"></i>
                    <strong>B·∫†N C√ì CH·∫ÆC CH·∫ÆN MU·ªêN X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU?</strong>
                </div>
                <p>H√†nh ƒë·ªông n√†y s·∫Ω:</p>
                <ul>
                    <li>X√≥a t·∫•t c·∫£ d·ªØ li·ªáu h·ªçc sinh, gi√°o vi√™n</li>
                    <li>X√≥a to√†n b·ªô ƒëi·ªÉm s·ªë, nh·∫≠n x√©t</li>
                    <li>X√≥a c√†i ƒë·∫∑t ph√¢n quy·ªÅn</li>
                    <li><strong>KH√îNG TH·ªÇ HO√ÄN T√ÅC</strong></li>
                </ul>
                <p class="text-danger"><strong>Vui l√≤ng nh·∫≠p "XOA TAT CA" ƒë·ªÉ x√°c nh·∫≠n:</strong></p>
                <input type="text" class="form-control" id="confirmText" placeholder="Nh·∫≠p: XOA TAT CA">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="fas fa-trash"></i> X√°c Nh·∫≠n X√≥a
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const resetAllBtn = document.getElementById('resetAllBtn');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const confirmText = document.getElementById('confirmText');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const logMessages = document.getElementById('logMessages');
    
    // Danh s√°ch b·∫£ng c·∫ßn x√≥a theo th·ª© t·ª±
    const tablesToDelete = [
        'User_Conduct',
        'User_Subjects', 
        'Role_Permissions',
        'Users'
    ];
    
    // Show confirmation modal
    resetAllBtn.addEventListener('click', function() {
        confirmModal.show();
    });
    
    // Enable/disable confirm button based on input
    confirmText.addEventListener('input', function() {
        const isValid = this.value.trim().toUpperCase() === 'XOA TAT CA';
        confirmDeleteBtn.disabled = !isValid;
    });
    
    // Reset input when modal is hidden
    document.getElementById('confirmModal').addEventListener('hidden.bs.modal', function() {
        confirmText.value = '';
        confirmDeleteBtn.disabled = true;
    });
    
    // Handle confirm delete
    confirmDeleteBtn.addEventListener('click', async function() {
        confirmModal.hide();
        
        // Show progress
        progressContainer.style.display = 'block';
        resetAllBtn.disabled = true;
        
        let completed = 0;
        let total = tablesToDelete.length;
        
        logMessages.innerHTML = '<strong>B·∫Øt ƒë·∫ßu x√≥a d·ªØ li·ªáu...</strong><br>';
        
        for (let i = 0; i < tablesToDelete.length; i++) {
            const tableName = tablesToDelete[i];
            
            try {
                // Update progress
                progressText.textContent = `ƒêang x√≥a b·∫£ng: ${tableName} (${i + 1}/${total})`;
                logMessages.innerHTML += `<span class="text-info">ƒêang x√≥a ${tableName}...</span><br>`;
                
                // Call backend
                const response = await fetch(`/reset/table/${tableName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    completed++;
                    const progress = (completed / total) * 100;
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = Math.round(progress) + '%';
                    
                    logMessages.innerHTML += `<span class="text-success">‚úÖ ${data.message}</span><br>`;
                } else {
                    logMessages.innerHTML += `<span class="text-danger">‚ùå L·ªói x√≥a ${tableName}: ${data.error}</span><br>`;
                }
                
                // Scroll to bottom of log
                logMessages.scrollTop = logMessages.scrollHeight;
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
                
            } catch (error) {
                logMessages.innerHTML += `<span class="text-danger">‚ùå L·ªói k·∫øt n·ªëi khi x√≥a ${tableName}: ${error.message}</span><br>`;
            }
        }
        
        // Complete
        progressText.textContent = `Ho√†n th√†nh! ƒê√£ x√≥a ${completed}/${total} b·∫£ng.`;
        logMessages.innerHTML += `<br><strong class="text-success">üéâ Qu√° tr√¨nh x√≥a d·ªØ li·ªáu ho√†n t·∫•t!</strong><br>`;
        logMessages.innerHTML += `<strong>T·ªïng k·∫øt: ${completed}/${total} b·∫£ng ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng.</strong><br>`;
        
        resetAllBtn.disabled = false;
    });
    
    // Toast notification function
    function showToast(message, type = 'info') {
        // You can implement toast notifications here if needed
        console.log(`${type.toUpperCase()}: ${message}`);
    }
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.list-group-item {
    border-left: 4px solid #007bff;
    margin-bottom: 2px;
}

.progress {
    height: 25px;
}

.progress-bar {
    transition: width 0.3s ease;
    color: white;
    font-weight: bold;
}

#logContainer {
    max-height: 300px;
    overflow-y: auto;
}

#logMessages {
    font-family: monospace;
    font-size: 0.9em;
    line-height: 1.4;
    white-space: pre-wrap;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

.alert-danger {
    border-left: 4px solid #dc3545;
}

.alert-warning {
    border-left: 4px solid #ffc107;
}
</style>
{% endblock %}
