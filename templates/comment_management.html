{% extends "base.html" %}

{% block title %}Quản lý nhận xét{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-comments"></i> Quản lý nhận xét</h2>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#commentModal" onclick="openCreateModal()">
                    <i class="fas fa-plus"></i> Thêm mẫu nhận xét
                </button>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="commentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="academic-tab" data-bs-toggle="tab" data-bs-target="#academic" type="button" role="tab">
                        <i class="fas fa-book text-primary"></i> Học tập
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="conduct-tab" data-bs-toggle="tab" data-bs-target="#conduct" type="button" role="tab">
                        <i class="fas fa-heart text-danger"></i> Hạnh kiểm
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ranking-tab" data-bs-toggle="tab" data-bs-target="#ranking" type="button" role="tab">
                        <i class="fas fa-trophy text-warning"></i> Xếp loại
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comment-general-tab" data-bs-toggle="tab" data-bs-target="#comment-general" type="button" role="tab">
                        <i class="fas fa-comment-dots text-info"></i> Nhận xét chung
                    </button>
                </li>
            </ul>

            

            <div class="tab-content mt-3" id="commentTabsContent">
                <!-- Tab Học tập -->
                <div class="tab-pane fade show active" id="academic" role="tabpanel">
                    <!-- Subtabs cho học tập -->
                    <ul class="nav nav-pills mb-3" id="academicTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="academic-encouragement-tab" data-bs-toggle="pill" data-bs-target="#academic-encouragement" type="button" role="tab">
                                <i class="fas fa-thumbs-up"></i> Khích lệ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="academic-reminder-tab" data-bs-toggle="pill" data-bs-target="#academic-reminder" type="button" role="tab">
                                <i class="fas fa-exclamation-triangle text-warning"></i> Nhắc nhở
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="academicTabContent">
                        <!-- Academic Encouragement -->
                        <div class="tab-pane fade show active" id="academic-encouragement" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'academic' and template[2] == 'encouragement' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-success">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Academic Reminder -->
                        <div class="tab-pane fade" id="academic-reminder" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'academic' and template[2] == 'reminder' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-warning">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Hạnh kiểm -->
                <div class="tab-pane fade" id="conduct" role="tabpanel">
                    <!-- Subtabs cho hạnh kiểm -->
                    <ul class="nav nav-pills mb-3" id="conductTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="conduct-encouragement-tab" data-bs-toggle="pill" data-bs-target="#conduct-encouragement" type="button" role="tab">
                                <i class="fas fa-thumbs-up"></i> Khích lệ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="conduct-reminder-tab" data-bs-toggle="pill" data-bs-target="#conduct-reminder" type="button" role="tab">
                                <i class="fas fa-exclamation-triangle text-warning"></i> Nhắc nhở
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="conductTabContent">
                        <!-- Conduct Encouragement -->
                        <div class="tab-pane fade show active" id="conduct-encouragement" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'conduct' and template[2] == 'encouragement' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-success">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Conduct Reminder -->
                        <div class="tab-pane fade" id="conduct-reminder" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'conduct' and template[2] == 'reminder' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-warning">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab ranking -->
                <div class="tab-pane fade" id="ranking" role="tabpanel">
                    <ul class="nav nav-pills mb-3" id="conductTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="ranking-encouragement-tab" data-bs-toggle="pill" data-bs-target="#ranking-encouragement" type="button" role="tab">
                                <i class="fas fa-thumbs-up"></i> Khích lệ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="ranking-reminder-tab" data-bs-toggle="pill" data-bs-target="#ranking-reminder" type="button" role="tab">
                                <i class="fas fa-exclamation-triangle text-warning"></i> Nhắc nhở
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content" id="rankingTabContent">
                        <!-- ranking Encouragement -->
                        <div class="tab-pane fade show active" id="ranking-encouragement" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'ranking' and template[2] == 'encouragement' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-success">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- ranking Reminder -->
                        <div class="tab-pane fade" id="ranking-reminder" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'ranking' and template[2] == 'reminder' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-warning">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                </div>

                <!-- Tab Nhận xét chung -->
                <div class="tab-pane fade" id="comment-general" role="tabpanel">
                    <!-- Subtabs cho nhận xét chung -->
                    <ul class="nav nav-pills mb-3" id="commentGeneralTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="comment-general-encouragement-tab" data-bs-toggle="pill" data-bs-target="#comment-general-encouragement" type="button" role="tab">
                                <i class="fas fa-thumbs-up"></i> Khích lệ
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="comment-general-reminder-tab" data-bs-toggle="pill" data-bs-target="#comment-general-reminder" type="button" role="tab">
                                <i class="fas fa-exclamation-triangle text-warning"></i> Nhắc nhở
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="commentGeneralTabContent">
                        <!-- Comment General Encouragement -->
                        <div class="tab-pane fade show active" id="comment-general-encouragement" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'comment_general' and template[2] == 'encouragement' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-success">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Comment General Reminder -->
                        <div class="tab-pane fade" id="comment-general-reminder" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Khoảng điểm</th>
                                            <th>Nội dung nhận xét</th>
                                            <th>Ngày tạo</th>
                                            <th width="150">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for template in templates %}
                                            {% if template[1] == 'comment_general' and template[2] == 'reminder' %}
                                            <tr>
                                                <td>
                                                    <span class="badge bg-warning">{{ template[3] }} - {{ template[4] }} điểm</span>
                                                </td>
                                                <td>{{ template[5] }}</td>
                                                <td>{{ template[6] }}</td>
                                                <td>
                                                    <button class="btn btn-sm btn-warning me-2 edit-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-edit"></i> Sửa
                                                    </button>
                                                    <button class="btn btn-sm btn-danger delete-template" data-id="{{ template[0] }}">
                                                        <i class="fas fa-trash"></i> Xóa
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</div>

<!-- Modal for Create/Edit Comment Template -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentModalLabel">Thêm mẫu nhận xét</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="commentForm">
                <div class="modal-body">
                    <input type="hidden" id="templateId" name="template_id">
                    
                    <div class="mb-3">
                        <label for="commentCategory" class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <select class="form-select" id="commentCategory" name="comment_category" required>
                            <option value="">-- Chọn danh mục --</option>
                            <option value="academic">Học tập</option>
                            <option value="conduct">Hạnh kiểm</option>
                            <option value="ranking">Xếp loại</option>
                            <option value="comment_general">Nhận xét chung</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="commentType" class="form-label">Loại nhận xét <span class="text-danger">*</span></label>
                        <select class="form-select" id="commentType" name="comment_type" required>
                            <option value="">-- Chọn loại nhận xét --</option>
                            <option value="encouragement">Khích lệ</option>
                            <option value="reminder">Nhắc nhở</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scoreRangeMin" class="form-label">Điểm tối thiểu <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="scoreRangeMin" name="score_range_min" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scoreRangeMax" class="form-label">Điểm tối đa <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="scoreRangeMax" name="score_range_max" min="0" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="commentText" class="form-label">Nội dung nhận xét <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="commentText" name="comment_text" rows="4" required placeholder="Nhập nội dung nhận xét..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="colorPicker" class="form-label">Màu xếp loại <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" id="colorPicker" name="color" value="#2e800b" title="Chọn màu cho xếp loại">
                            <div class="color-presets d-flex gap-1">
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #2e800b; width: 30px; height: 30px;" data-color="#2e800b" title="Xanh lá"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #28a745; width: 30px; height: 30px;" data-color="#28a745" title="Xanh lá sáng"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #17a2b8; width: 30px; height: 30px;" data-color="#17a2b8" title="Xanh dương"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #6f42c1; width: 30px; height: 30px;" data-color="#6f42c1" title="Tím"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #e83e8c; width: 30px; height: 30px;" data-color="#e83e8c" title="Hồng"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #fd7e14; width: 30px; height: 30px;" data-color="#fd7e14" title="Cam"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #ffc107; width: 30px; height: 30px;" data-color="#ffc107" title="Vàng"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #dc3545; width: 30px; height: 30px;" data-color="#dc3545" title="Đỏ"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #6c757d; width: 30px; height: 30px;" data-color="#6c757d" title="Xám"></button>
                                <button type="button" class="btn btn-sm color-preset" style="background-color: #343a40; width: 30px; height: 30px;" data-color="#343a40" title="Đen"></button>
                            </div>
                        </div>
                        <small class="form-text text-muted">Màu này sẽ được sử dụng để hiển thị xếp loại trong báo cáo học sinh</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Hướng dẫn:</strong>
                        <ul class="mb-0 mt-2">
                            <li><strong>Danh mục:</strong> Chọn "Học tập" cho nhận xét về điểm chênh lệch học tập, "Hạnh kiểm" cho nhận xét về điểm chệnh lệch rèn luyện, "Xếp loại" cho nhận xét về điểm tổng điểm, "Nhận xét chung" cho tổng điểm</li>
                            <li><strong>Khích lệ:</strong> Thiết lập từ 0~ (sẽ dựa vào số điểm tăng để phán đoán)</li>
                            <li><strong>Nhắc nhở:</strong> Thiết lập từ 1~ (sẽ dựa vào số điểm giảm để phán đoán)</li>
                            <li><strong>Khoảng điểm:</strong> Là khoảng điểm Học tập/Hạnh kiểm/Tổng điểm</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Edit Comment Template -->
<div class="modal fade" id="editTemplateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editCommentForm">
                <div class="modal-header">
                    <h5 class="modal-title">Sửa mẫu nhận xét</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTemplateId" name="template_id">
                    
                    <div class="mb-3">
                        <label for="editCommentCategory" class="form-label">Danh mục <span class="text-danger">*</span></label>
                        <select class="form-select" id="editCommentCategory" name="comment_category" required>
                            <option value="">-- Chọn danh mục --</option>
                            <option value="academic">Học tập</option>
                            <option value="conduct">Hạnh kiểm</option>
                            <option value="ranking">Xếp loại</option>
                            <option value="comment_general">Nhận xét chung</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="editCommentType" class="form-label">Loại nhận xét <span class="text-danger">*</span></label>
                        <select class="form-select" id="editCommentType" name="comment_type" required>
                            <option value="">-- Chọn loại --</option>
                            <option value="encouragement">Khích lệ</option>
                            <option value="reminder">Nhắc nhở</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editScoreRangeMin" class="form-label">Điểm tối thiểu <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editScoreRangeMin" name="score_range_min" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editScoreRangeMax" class="form-label">Điểm tối đa <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editScoreRangeMax" name="score_range_max" min="0" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editCommentText" class="form-label">Nội dung nhận xét <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="editCommentText" name="comment_text" rows="4" required placeholder="Nhập nội dung nhận xét..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="editColorPicker" class="form-label">Màu xếp loại <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color" class="form-control form-control-color" id="editColorPicker" name="color" value="#2e800b" title="Chọn màu cho xếp loại">
                            <div class="color-presets d-flex gap-1">
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #2e800b; width: 30px; height: 30px;" data-color="#2e800b" title="Xanh lá"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #28a745; width: 30px; height: 30px;" data-color="#28a745" title="Xanh lá sáng"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #17a2b8; width: 30px; height: 30px;" data-color="#17a2b8" title="Xanh dương"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #6f42c1; width: 30px; height: 30px;" data-color="#6f42c1" title="Tím"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #e83e8c; width: 30px; height: 30px;" data-color="#e83e8c" title="Hồng"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #fd7e14; width: 30px; height: 30px;" data-color="#fd7e14" title="Cam"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #ffc107; width: 30px; height: 30px;" data-color="#ffc107" title="Vàng"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #dc3545; width: 30px; height: 30px;" data-color="#dc3545" title="Đỏ"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #6c757d; width: 30px; height: 30px;" data-color="#6c757d" title="Xám"></button>
                                <button type="button" class="btn btn-sm color-preset-edit" style="background-color: #343a40; width: 30px; height: 30px;" data-color="#343a40" title="Đen"></button>
                            </div>
                        </div>
                        <small class="form-text text-muted">Màu này sẽ được sử dụng để hiển thị xếp loại trong báo cáo học sinh</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active" checked>
                            <label class="form-check-label" for="editIsActive">Kích hoạt</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let isEditMode = false;

function toggleEditColorPicker() {
    const category = document.getElementById('editCommentCategory');
    const colorArea = document.getElementById('editColorPicker').closest('.mb-3');
    if (category.value === 'ranking') {
        colorArea.style.display = '';
    } else {
        colorArea.style.display = 'none';
    }
}

// Tương tự cho modal tạo mới
function toggleCreateColorPicker() {
    const category = document.getElementById('commentCategory');
    const colorArea = document.getElementById('colorPicker').closest('.mb-3');
    if (category.value === 'ranking') {
        colorArea.style.display = '';
    } else {
        colorArea.style.display = 'none';
    }
}

// Mở modal tạo mới
function openCreateModal() {
    isEditMode = false;
    document.getElementById('commentModalLabel').textContent = 'Thêm mẫu nhận xét';
    document.getElementById('commentForm').reset();
    document.getElementById('templateId').value = '';
}

// Mở modal chỉnh sửa
function openEditModal(id, category, type, minScore, maxScore, text) {
    isEditMode = true;
    document.getElementById('commentModalLabel').textContent = 'Chỉnh sửa mẫu nhận xét';
    document.getElementById('templateId').value = id;
    document.getElementById('commentCategory').value = category;
    document.getElementById('commentType').value = type;
    document.getElementById('scoreRangeMin').value = minScore;
    document.getElementById('scoreRangeMax').value = maxScore;
    document.getElementById('commentText').value = text;
    
    // Mở modal
    const modal = new bootstrap.Modal(document.getElementById('commentModal'));
    modal.show();
}

// Xử lý submit form
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const url = isEditMode ? '/api/comment_template/edit' : '/api/comment_template/create';
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            // Đóng modal đúng cách
            const modal = bootstrap.Modal.getInstance(document.getElementById('commentModal'));
            if (modal) {
                modal.hide();
                // Xóa backdrop thủ công nếu cần
                setTimeout(() => {
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('overflow');
                    document.body.style.removeProperty('padding-right');
                }, 300);
            }
            // Refresh grid thay vì reload trang
            refreshCommentGrid();
        } else {
            showError('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        showError('Lỗi kết nối: ' + error);
    });
});

// Xử lý submit form edit
document.getElementById('editCommentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/api/comment_template/edit', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            // Đóng modal đúng cách
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTemplateModal'));
            if (modal) {
                modal.hide();
                // Xóa backdrop thủ công nếu cần
                setTimeout(() => {
                    document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('overflow');
                    document.body.style.removeProperty('padding-right');
                }, 300);
            }
            // Refresh grid thay vì reload trang
            refreshCommentGrid();
        } else {
            showError('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        showError('Lỗi kết nối: ' + error);
    });
});

// Xử lý edit và xóa template
document.addEventListener('DOMContentLoaded', function() {
    // Xử lý button edit
    const editButtons = document.querySelectorAll('.edit-template');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-id');
            editTemplate(templateId);
        });
    });

    // Xử lý button delete
    const deleteButtons = document.querySelectorAll('.delete-template');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-id');
            if (confirm('Bạn có chắc chắn muốn xóa mẫu nhận xét này?')) {
                deleteTemplate(templateId);
            }
        });
    });
});

function deleteTemplate(templateId) {
    fetch(`/comment_template/delete/${templateId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess(data.message);
            // Refresh grid thay vì reload trang
            refreshCommentGrid();
        } else {
            showError('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        showError('Lỗi kết nối: ' + error);
    });
}

function editTemplate(templateId) {
    // Fetch template data
    fetch(`/api/comment_template/${templateId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const template = data.template;
            // Populate modal fields
            document.getElementById('editTemplateId').value = template.id;
            document.getElementById('editCommentCategory').value = template.comment_category;
            document.getElementById('editCommentType').value = template.comment_type;
            document.getElementById('editScoreRangeMin').value = template.score_range_min;
            document.getElementById('editScoreRangeMax').value = template.score_range_max;
            document.getElementById('editCommentText').value = template.comment_text;
            console.log('Màu được đặt trong edit modal:', template.color); // Debug log
            document.getElementById('editColorPicker').value = template.color || '#2e800b';
            document.getElementById('editIsActive').checked = template.is_active;
            
            toggleEditColorPicker();

            // Đảm bảo không có modal nào khác đang mở
            const existingModals = document.querySelectorAll('.modal.show');
            existingModals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
            
            // Xóa backdrop cũ nếu có
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
            
            // Delay một chút trước khi mở modal mới
            setTimeout(() => {
                const editModal = new bootstrap.Modal(document.getElementById('editTemplateModal'));
                editModal.show();
            }, 100);
        } else {
            showError('Lỗi: ' + data.error);
        }
    })
    .catch(error => {
        showError('Lỗi kết nối: ' + error);
    });
}

function refreshCommentGrid() {
    // Lấy tab hiện tại đang active
    const activeMainTab = document.querySelector('#commentTabs .nav-link.active');
    let activeSubTab = null;
    
    // Tìm subtab active dựa trên main tab hiện tại
    if (activeMainTab) {
        const mainTabTarget = activeMainTab.getAttribute('data-bs-target');
        if (mainTabTarget === '#academic') {
            activeSubTab = document.querySelector('#academicTabs .nav-link.active');
        } else if (mainTabTarget === '#conduct') {
            activeSubTab = document.querySelector('#conductTabs .nav-link.active');
        } else if (mainTabTarget === '#ranking') {
            activeSubTab = document.querySelector('#conductTabs .nav-link.active');
        } else if (mainTabTarget === '#comment-general') {
            activeSubTab = document.querySelector('#commentGeneralTabs .nav-link.active');
        }
    }
    
    let tabInfo = '';
    if (activeMainTab && activeSubTab) {
        const mainTabTarget = activeMainTab.getAttribute('data-bs-target');
        const subTabTarget = activeSubTab.getAttribute('data-bs-target');
        tabInfo = `${mainTabTarget}|${subTabTarget}`;
    }
    
    // Lưu vào sessionStorage
    if (tabInfo) {
        sessionStorage.setItem('activeTab', tabInfo);
        console.log('Đã lưu tab state:', tabInfo); // Debug log
    }
    
    // Reload trang
    window.location.reload();
}

// Khôi phục vị trí tab sau khi reload
document.addEventListener('DOMContentLoaded', function() {
    // Khôi phục tab từ sessionStorage
    const savedTabInfo = sessionStorage.getItem('activeTab');
    console.log('Khôi phục tab state:', savedTabInfo); // Debug log
    
    if (savedTabInfo) {
        const [mainTabTarget, subTabTarget] = savedTabInfo.split('|');
        console.log('Main tab:', mainTabTarget, 'Sub tab:', subTabTarget); // Debug log
        
        // Activate main tab
        const mainTabElement = document.querySelector(`[data-bs-target="${mainTabTarget}"]`);
        if (mainTabElement) {
            const mainTab = new bootstrap.Tab(mainTabElement);
            mainTab.show();
            
            // Wait for main tab to show then activate sub tab
            setTimeout(() => {
                const subTabElement = document.querySelector(`[data-bs-target="${subTabTarget}"]`);
                if (subTabElement) {
                    const subTab = new bootstrap.Tab(subTabElement);
                    subTab.show();
                    console.log('Đã khôi phục tab:', subTabTarget); // Debug log
                }
            }, 100);
        }
        
        // Clear saved tab info
        sessionStorage.removeItem('activeTab');
    }
    
    // Xử lý button edit
    const editButtons = document.querySelectorAll('.edit-template');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-id');
            editTemplate(templateId);
        });
    });

    // Xử lý button delete
    const deleteButtons = document.querySelectorAll('.delete-template');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.getAttribute('data-id');
            if (confirm('Bạn có chắc chắn muốn xóa mẫu nhận xét này?')) {
                deleteTemplate(templateId);
            }
        });
    });
    
    // Xử lý color picker presets
    document.querySelectorAll('.color-preset').forEach(button => {
        button.addEventListener('click', function() {
            const color = this.getAttribute('data-color');
            document.getElementById('colorPicker').value = color;
        });
    });
    
    // Xử lý color picker presets cho edit modal
    document.querySelectorAll('.color-preset-edit').forEach(button => {
        button.addEventListener('click', function() {
            const color = this.getAttribute('data-color');
            document.getElementById('editColorPicker').value = color;
        });
    });
    
    // Xử lý sự kiện đóng modal để đảm bảo backdrop được xóa
    const commentModal = document.getElementById('commentModal');
    const editTemplateModal = document.getElementById('editTemplateModal');
    
    [commentModal, editTemplateModal].forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function () {
            // Xóa tất cả backdrop còn sót lại
            setTimeout(() => {
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                document.body.classList.remove('modal-open');
                document.body.style.removeProperty('overflow');
                document.body.style.removeProperty('padding-right');
            }, 100);
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('editCommentCategory').addEventListener('change', toggleEditColorPicker);
    toggleEditColorPicker();

    document.getElementById('commentCategory').addEventListener('change', toggleCreateColorPicker);
    toggleCreateColorPicker();
});

</script>
{% endblock %}
