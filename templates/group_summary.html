{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Table improvements */
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .prev-period-data {
        color: #6c757d;
        font-size: 0.875em;
        font-style: italic;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .row.g-3 > .col-12.col-md-4 {
            height: fit-content;
            min-height: 100%;
        }
        .d-flex.gap-2 {
            flex-wrap: wrap;
            gap: 8px !important;
        }
        .btn-compact {
            min-width: 40px;
        }
        .search-form-card .row {
            flex-direction: column;
        }
        .search-form-card .col-md-4 {
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        select[multiple] {
            height: auto !important;
        }
        .btn {
            margin-bottom: 0.5rem;
        }
        .table {
            font-size: 0.7rem;
        }
        th, td {
            padding: 0.5rem !important;
        }
    }

    /* Toggle button and search form styling */
    .btn-compact {
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-compact.btn-success {
        background: linear-gradient(135deg, #198754, #20c997);
        border: none;
        color: white;
    }
    .btn-compact.btn-primary {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        border: none;
        color: white;
    }
    .btn-compact.active {
        background: linear-gradient(135deg, #6610f2, #0d6efd);
        transform: scale(1.05);
    }

    /* Search form card styling */
    .search-form-card {
        margin-bottom: 20px;
        border: none;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: max-height 0.3s, opacity 0.3s;
        max-height: 500px;
        opacity: 1;
    }
    .search-form-card.collapsed {
        max-height: 0 !important;
        opacity: 0 !important;
        overflow: hidden !important;
        margin-bottom: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        transition: max-height 0.3s, opacity 0.3s;
    }
    .search-form-card.collapsed .card-body {
        padding: 0;
    }
    .search-form-card .card-body {
        padding: 20px;
        transition: padding 0.3s ease;
    }
    .search-form-card .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .search-form-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }
    .search-form-card .card-header h6 {
        color: #495057;
        font-weight: 600;
    }

    /* Animation for collapse/expand */
    @keyframes slideDown {
        from {
            max-height: 0;
            opacity: 0;
        }
        to {
            max-height: 500px;
            opacity: 1;
        }
    }
    @keyframes slideUp {
        from {
            max-height: 500px;
            opacity: 1;
        }
        to {
            max-height: 0;
            opacity: 0;
        }
    }
    .search-form-card.expanding {
        animation: slideDown 0.3s ease-out forwards;
    }
    .search-form-card.collapsing {
        animation: slideUp 0.3s ease-out forwards;
    }

    /* Misc */
    .save-status {
        min-width: 80px;
        display: inline-block;
        white-space: nowrap;
    }
    .auto-save-comment {
        resize: vertical;
    }
    .auto-save-comment:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
</style>
{% endblock %}

{% block content %}
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-12">
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Thống kê nhóm</h2>
                    
                    <!-- Toggle button for search form -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary btn-compact" id="toggleSearchForm" data-bs-toggle="tooltip" title="Hiện/Ẩn điều kiện tìm kiếm">
                            <i class="fas fa-filter"></i>
                            <span class="d-none d-md-inline ms-1">Bộ lọc</span>
                        </button>
                    </div>
                </div>

                <!-- Search Form Card -->
                <div class="card search-form-card mb-3" id="searchFormCard">
                    <div class="card-body">
                        <form method="POST" id="searchForm">
                            <div class="row g-3 justify-content-center">
                                <!-- Cột bên trái: Điều kiện ngày tháng (centered) -->
                                <div class="col-md-5">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <!-- Chọn loại thời gian -->
                                            <div class="mb-3">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="period_type" id="week_type" value="week" {% if period_type == 'week' %}checked{% endif %}>
                                                    <label class="btn btn-outline-primary" for="week_type">Tuần</label>
                                                    <input type="radio" class="btn-check" name="period_type" id="month_type" value="month" {% if period_type == 'month' %}checked{% endif %}>
                                                    <label class="btn btn-outline-primary" for="month_type">Tháng</label>
                                                </div>
                                            </div>

                                            <!-- Điều hướng thời gian -->
                                            <div class="mb-3">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <button type="button" class="btn btn-outline-secondary" id="prevPeriod">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <div class="text-center flex-grow-1 mx-2">
                                                        <strong id="periodDisplay">Đang tải...</strong>
                                                    </div>
                                                    <button type="button" class="btn btn-outline-secondary" id="nextPeriod">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <div class="d-flex align-items-center gap-2">
                                                    <input type="date" name="date_from" id="date_from" class="form-control form-control-sm" value="{{ date_from or '' }}" readonly style="flex: 1;">
                                                    <span class="text-muted">~</span>
                                                    <input type="date" name="date_to" id="date_to" class="form-control form-control-sm" value="{{ date_to or '' }}" readonly style="flex: 1;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden inputs for default values -->
                                <input type="hidden" name="groups" value="">
                                <input type="hidden" name="data_source" value="all">
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12 text-center">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="table-container" class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="text-nowrap">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="group_name" data-order="{{ 'desc' if sort_by == 'group_name' and sort_order == 'asc' else 'asc' }}">
                                                Nhóm
                                                {% if sort_by == 'group_name' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th colspan="3" class="text-center">Kỳ Trước</th>
                                        <th colspan="3" class="text-center">Kỳ Này</th>
                                        <th rowspan="2" class="text-nowrap">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="progress" data-order="{{ 'desc' if sort_by == 'progress' and sort_order == 'asc' else 'asc' }}">
                                                Tiến bộ
                                                {% if sort_by == 'progress' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="prev_study" data-order="{{ 'desc' if sort_by == 'prev_study' and sort_order == 'asc' else 'asc' }}">
                                                Học tập
                                                {% if sort_by == 'prev_study' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="prev_conduct" data-order="{{ 'desc' if sort_by == 'prev_conduct' and sort_order == 'asc' else 'asc' }}">
                                                Hạnh kiểm
                                                {% if sort_by == 'prev_conduct' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="prev_total" data-order="{{ 'desc' if sort_by == 'prev_total' and sort_order == 'asc' else 'asc' }}">
                                                Tổng
                                                {% if sort_by == 'prev_total' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="now_study" data-order="{{ 'desc' if sort_by == 'now_study' and sort_order == 'asc' else 'asc' }}">
                                                Học tập
                                                {% if sort_by == 'now_study' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="now_conduct" data-order="{{ 'desc' if sort_by == 'now_conduct' and sort_order == 'asc' else 'asc' }}">
                                                Hạnh kiểm
                                                {% if sort_by == 'now_conduct' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="now_total" data-order="{{ 'desc' if sort_by == 'now_total' and sort_order == 'asc' else 'asc' }}">
                                                Tổng
                                                {% if sort_by == 'now_total' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in records %}
                                        <tr>
                                            <td>{{ record[0] }}</td>
                                            <td class="text-center">{{ record[2] }}</td>
                                            <td class="text-center">{{ record[3] }}</td>
                                            <td class="text-center">{{ record[1] }}</td>
                                            <td class="text-center">{{ record[5] }}</td>
                                            <td class="text-center">{{ record[6] }}</td>
                                            <td class="text-center">{{ record[4] }}</td>
                                            <td class="text-center">
                                                {% if record[7] > 0 %}
                                                    <span class="text-success">+{{ record[7] }}</span>
                                                {% elif record[7] < 0 %}
                                                    <span class="text-danger">{{ record[7] }}</span>
                                                {% else %}
                                                    <span class="text-muted">{{ record[7] }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục cho việc quản lý thời gian
        let currentDate = new Date();
        let currentPeriodType = 'week';
        let isCollapsed = false; // Global variable for collapse state
        
        // Lưu trữ dữ liệu bảng để sort phía client
        let tableData = [];
        let currentSortBy = '{{ sort_by }}';
        let currentSortOrder = '{{ sort_order }}';
        
        // Hàm hiển thị thông báo lỗi
        function showError(message) {
            console.error(message);
            // Có thể thêm toast notification ở đây nếu cần
        }

        // Hàm lấy tuần hiện tại từ backend
        async function loadCurrentWeek() {
            const today = new Date();
            const todayStr = today.toISOString().slice(0, 10);
            try {
                const res = await fetch(`/api/week_by_date?date=${todayStr}`);
                const data = await res.json();
                if (res.ok && !data.error) {
                    isProgrammaticChange = true;
                    document.getElementById('date_from').value = data.from_date;
                    document.getElementById('date_to').value = data.to_date;
                    document.getElementById('periodDisplay').textContent = `Tuần ${data.week_number}`;
                    window.currentWeekNumber = data.week_number;
                    isProgrammaticChange = false;
                } else {
                    showError(data.error || 'Không lấy được dữ liệu tuần');
                }
            } catch (error) {
                showError('Không thể kết nối tới máy chủ');
            }
        }

        // Hàm chuyển tuần (lùi/tới)
        async function changeWeek(direction) {
            let week = window.currentWeekNumber || 1;
            week = direction === 'next' ? week + 1 : week - 1;
            try {
                const res = await fetch(`/api/week_by_number?week_number=${week}`);
                const data = await res.json();
                if (res.ok && !data.error) {
                    isProgrammaticChange = true;
                    document.getElementById('date_from').value = data.from_date;
                    document.getElementById('date_to').value = data.to_date;
                    document.getElementById('periodDisplay').textContent = `Tuần ${data.week_number}`;
                    window.currentWeekNumber = data.week_number;
                    isProgrammaticChange = false;
                } else {
                    showError(data.error || 'Không lấy được dữ liệu tuần');
                }
            } catch (error) {
                showError('Không thể kết nối tới máy chủ');
            }
        }

        // Hàm lấy ngày đầu tháng
        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        // Hàm lấy ngày cuối tháng
        function getLastDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0);
        }

        // Hàm format ngày về yyyy-mm-dd
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Hàm cập nhật hiển thị thời gian
        async function updatePeriodDisplay() {
            const periodDisplay = document.getElementById('periodDisplay');
            const dateFromInput = document.getElementById('date_from');
            const dateToInput = document.getElementById('date_to');

            if (currentPeriodType === 'week') {

            } else {
                const firstDay = getFirstDayOfMonth(currentDate);
                const lastDay = getLastDayOfMonth(currentDate);

                isProgrammaticChange = true;
                dateFromInput.value = formatDate(firstDay);
                dateToInput.value = formatDate(lastDay);
                isProgrammaticChange = false;

                const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                                   'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                periodDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
        }
        // Biến để theo dõi việc khởi tạo
        let isInitializing = true;
        let isProgrammaticChange = false; // Flag để phân biệt giữa user change và programmatic change
        
        // Hàm lưu dữ liệu bảng từ DOM
        function loadTableData() {
            tableData = [];
            const rows = document.querySelectorAll('#table-container tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 8) {
                    // Lấy giá trị progress (remove span tags)
                    let progressCell = cells[7];
                    let progressText = progressCell.textContent.trim();
                    let progressValue = parseFloat(progressText.replace('+', '')) || 0;
                    
                    tableData.push({
                        group_name: cells[0].textContent.trim(),
                        prev_study: parseFloat(cells[1].textContent.trim()) || 0,
                        prev_conduct: parseFloat(cells[2].textContent.trim()) || 0,
                        prev_total: parseFloat(cells[3].textContent.trim()) || 0,
                        now_study: parseFloat(cells[4].textContent.trim()) || 0,
                        now_conduct: parseFloat(cells[5].textContent.trim()) || 0,
                        now_total: parseFloat(cells[6].textContent.trim()) || 0,
                        progress: progressValue
                    });
                }
            });
        }
        
        // Hàm so sánh tên tiếng Việt
        function vietnameseCompare(a, b) {
            return a.localeCompare(b, 'vi', {sensitivity: 'base'});
        }
        
        // Hàm sort dữ liệu
        function sortTableData(sortBy, sortOrder) {
            tableData.sort((a, b) => {
                let valA = a[sortBy];
                let valB = b[sortBy];
                
                if (sortBy === 'group_name') {
                    const comparison = vietnameseCompare(valA, valB);
                    return sortOrder === 'asc' ? comparison : -comparison;
                } else {
                    const comparison = valA - valB;
                    return sortOrder === 'asc' ? comparison : -comparison;
                }
            });
        }
        
        // Hàm render lại bảng
        function renderTable() {
            const tbody = document.querySelector('#table-container tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            tableData.forEach(record => {
                const row = document.createElement('tr');
                
                // Progress cell với màu sắc
                let progressHtml = '';
                if (record.progress > 0) {
                    progressHtml = `<span class="text-success">+${record.progress}</span>`;
                } else if (record.progress < 0) {
                    progressHtml = `<span class="text-danger">${record.progress}</span>`;
                } else {
                    progressHtml = `<span class="text-muted">${record.progress}</span>`;
                }
                
                row.innerHTML = `
                    <td>${record.group_name}</td>
                    <td class="text-center">${record.prev_study}</td>
                    <td class="text-center">${record.prev_conduct}</td>
                    <td class="text-center">${record.prev_total}</td>
                    <td class="text-center">${record.now_study}</td>
                    <td class="text-center">${record.now_conduct}</td>
                    <td class="text-center">${record.now_total}</td>
                    <td class="text-center">${progressHtml}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Hàm cập nhật sort indicators trong header
        function updateSortIndicators(sortBy, sortOrder) {
            document.querySelectorAll('.sort-link').forEach(link => {
                const linkSortBy = link.getAttribute('data-sort');
                const arrow = sortOrder === 'asc' ? '▲' : '▼';
                const sortIcon = '<i class="fas fa-sort"></i>';
                
                // Lấy text của link (không bao gồm icon)
                let linkText = '';
                if (linkSortBy === 'group_name') linkText = 'Nhóm';
                else if (linkSortBy === 'prev_study') linkText = 'Học tập';
                else if (linkSortBy === 'prev_conduct') linkText = 'Hạnh kiểm';
                else if (linkSortBy === 'prev_total') linkText = 'Tổng';
                else if (linkSortBy === 'now_study') linkText = 'Học tập';
                else if (linkSortBy === 'now_conduct') linkText = 'Hạnh kiểm';
                else if (linkSortBy === 'now_total') linkText = 'Tổng';
                else if (linkSortBy === 'progress') linkText = 'Tiến bộ';
                
                if (linkSortBy === sortBy) {
                    link.innerHTML = linkText + '\n                                ' + arrow;
                    // Cập nhật order cho lần click tiếp theo
                    link.setAttribute('data-order', sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    link.innerHTML = linkText + '\n                                ' + sortIcon;
                    link.setAttribute('data-order', 'asc');
                }
            });
        }

        // Biến để theo dõi việc khởi tạo

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded for group_summary');
            
            // ===== TOGGLE SEARCH FORM LOGIC =====
            const toggleSearchForm = document.getElementById('toggleSearchForm');
            const searchFormCard = document.getElementById('searchFormCard');
            let isCollapsed = false;
            
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Toggle search form
            if (toggleSearchForm && searchFormCard) {
                toggleSearchForm.addEventListener('click', function() {
                    console.log('Toggle clicked, isCollapsed:', isCollapsed);
                    if (isCollapsed) {
                        console.log('Expanding...');
                        // Expand
                        searchFormCard.classList.remove('collapsed', 'collapsing');
                        searchFormCard.classList.add('expanding');
                        this.classList.add('active');
                        this.innerHTML = '<i class="fas fa-eye-slash"></i><span class="d-none d-md-inline ms-1">Ẩn lọc</span>';
                        isCollapsed = false;
                        
                        // Remove animation class after animation completes
                        setTimeout(() => {
                            searchFormCard.classList.remove('expanding');
                            console.log('Expanded, classes:', searchFormCard.classList.toString());
                        }, 300);
                    } else {
                        // Collapse
                        console.log('Collapsing...');
                        searchFormCard.classList.remove('expanding');
                        searchFormCard.classList.add('collapsing');
                        this.classList.remove('active');
                        this.innerHTML = '<i class="fas fa-filter"></i><span class="d-none d-md-inline ms-1">Bộ lọc</span>';
                        
                        // Add collapsed class after animation completes
                        setTimeout(() => {
                            searchFormCard.classList.remove('collapsing');
                            searchFormCard.classList.add('collapsed');
                            isCollapsed = true;
                            console.log('Collapsed, classes:', searchFormCard.classList.toString());
                        }, 300);
                    }
                });
            }
            
            // Kiểm tra xem có giá trị date_from và date_to từ server không
            const dateFromValue = document.getElementById('date_from').value;
            const dateToValue = document.getElementById('date_to').value;
            
            // Lấy period_type từ server
            const serverPeriodType = '{{ period_type }}';
            
            if (dateFromValue && dateToValue) {
                // Nếu có giá trị từ server, sử dụng giá trị đó
                const fromDate = new Date(dateFromValue);
                const toDate = new Date(dateToValue);
                
                // Sử dụng period_type từ server
                currentPeriodType = serverPeriodType || 'week';
                
                if (currentPeriodType === 'week') {
                    document.getElementById('week_type').checked = true;
                    // Cập nhật display cho tuần hiện tại dựa vào giá trị từ server
                    // Fetch week number từ date_from
                    fetch(`/api/week_by_date?date=${dateFromValue}`)
                        .then(res => res.json())
                        .then(data => {
                            if (!data.error) {
                                document.getElementById('periodDisplay').textContent = `Tuần ${data.week_number}`;
                                window.currentWeekNumber = data.week_number;
                            }
                        })
                        .catch(error => console.error('Error fetching week number:', error));
                } else {
                    // Tháng: sử dụng ngày đầu tháng  
                    currentDate = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
                    document.getElementById('month_type').checked = true;
                    
                    // Cập nhật display cho tháng
                    const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                                       'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                    document.getElementById('periodDisplay').textContent = `${monthNames[fromDate.getMonth()]} ${fromDate.getFullYear()}`;
                }
            } else {
                // Chỉ load tuần hiện tại khi chưa có giá trị từ server
                loadCurrentWeek();
            }
            
            // Hoàn thành khởi tạo
            isInitializing = false;
            
            // Load dữ liệu bảng ban đầu
            loadTableData();

            document.querySelectorAll('input[name="period_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentPeriodType = this.value;
                    if (currentPeriodType === 'week') {
                        loadCurrentWeek();
                    } else {
                        updatePeriodDisplay();
                    }
                });
            });

            document.getElementById('prevPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    changeWeek('prev');
                } else {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    updatePeriodDisplay();
                }
            });

            document.getElementById('nextPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    changeWeek('next');
                } else {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    updatePeriodDisplay();
                }
            });

            // Không auto-submit khi date thay đổi
            // Người dùng sẽ phải click nút "Tìm kiếm" để submit form
            
            // ===== CLIENT-SIDE SORTING LOGIC =====
            // Add event listeners for sort links
            document.querySelectorAll('.sort-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const sortBy = this.getAttribute('data-sort');
                    const sortOrder = this.getAttribute('data-order');
                    
                    console.log('Sort clicked:', sortBy, sortOrder);
                    
                    // Sort dữ liệu
                    sortTableData(sortBy, sortOrder);
                    
                    // Render lại bảng
                    renderTable();
                    
                    // Cập nhật sort indicators
                    updateSortIndicators(sortBy, sortOrder);
                    
                    // Lưu trạng thái sort hiện tại
                    currentSortBy = sortBy;
                    currentSortOrder = sortOrder;
                });
            });
        });
    </script>
    <style>
        @media (max-width: 768px) {
            .form-group {
                margin-bottom: 1rem;
            }

            select[multiple] {
                height: auto !important;
            }

            .btn {
                margin-bottom: 0.5rem;
            }

            .table {
                font-size: 0.7rem;
            }

            th, td {
                padding: 0.5rem !important;
            }
        }

        /* Toggle button and search form styling */
        .btn-compact {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-compact:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-compact.btn-success {
            background: linear-gradient(135deg, #198754, #20c997);
            border: none;
            color: white;
        }

        .btn-compact.btn-primary {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            border: none;
            color: white;
        }

        .btn-compact.active {
            background: linear-gradient(135deg, #6610f2, #0d6efd);
            transform: scale(1.05);
        }

        /* Search form card styling */
        .search-form-card {
            margin-bottom: 20px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-form-card.collapsed {
            max-height: 0;
            overflow: hidden;
            margin-bottom: 0;
            padding: 0;
            border: none;
            box-shadow: none;
        }

        .search-form-card.collapsed .card-body {
            padding: 0;
        }

        .search-form-card .card-body {
            padding: 20px;
            transition: padding 0.3s ease;
        }

        /* Animation for collapse/expand */
        @keyframes slideDown {
            from {
                max-height: 0;
                opacity: 0;
            }
            to {
                max-height: 500px;
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                max-height: 500px;
                opacity: 1;
            }
            to {
                max-height: 0;
                opacity: 0;
            }
        }

        .search-form-card.expanding {
            animation: slideDown 0.3s ease-out forwards;
        }

        .search-form-card.collapsing {
            animation: slideUp 0.3s ease-out forwards;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .d-flex.gap-2 {
                flex-wrap: wrap;
                gap: 8px !important;
            }
            
            .btn-compact {
                min-width: 40px;
            }
        }
    </style>
{% endblock %}