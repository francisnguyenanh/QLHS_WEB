{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Toggle button and search form styling */
    .btn-compact {
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: 500;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn-compact.btn-primary {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        border: none;
        color: white;
    }

    .btn-compact.active {
        background: linear-gradient(135deg, #6610f2, #0d6efd);
        transform: scale(1.05);
    }

    /* Search form card styling */
    .search-form-card {
        margin-bottom: 20px;
        border: none;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease-in-out;
        overflow: hidden;
        max-height: 1000px; /* Large enough to show content */
        opacity: 1;
    }

    .search-form-card.collapsed {
        max-height: 0 !important;
        margin-bottom: 0 !important;
        opacity: 0 !important;
        box-shadow: none !important;
    }

    .search-form-card .card-body {
        padding: 20px;
        transition: all 0.3s ease-in-out;
    }

    .search-form-card.collapsed .card-body {
        padding: 0 !important;
    }

    tbody, td, tfoot, th, thead, tr {
        border-style: None;
    }
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .d-flex.gap-2 {
            flex-wrap: wrap;
            gap: 8px !important;
        }
        
        .btn-compact {
            min-width: 40px;
        }
        
        .mb-3 {
            margin-bottom: 1rem !important;
        }

        select[multiple] {
            height: auto !important;
        }

        .btn {
            margin-bottom: 0.5rem;
        }

        .table {
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.5rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-md-12">
                <!-- Flash messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Thống kê nhóm</h2>
                    
                    <!-- Toggle button for search form -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary btn-compact" id="toggleSearchForm" data-bs-toggle="tooltip" title="Hiện/Ẩn điều kiện tìm kiếm">
                            <i class="fas fa-filter"></i>
                            <span class="d-none d-md-inline ms-1">Bộ lọc</span>
                        </button>
                    </div>
                </div>

                <!-- Search Form Card -->
                <div class="card search-form-card mb-3" id="searchFormCard" style="overflow: hidden; transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 500px; opacity: 1;">
                    <div class="card-body">
                        <form method="POST" id="searchForm">
                            <div class="row g-3">
                                <!-- Cột bên trái: Điều kiện ngày tháng -->
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <!-- Chọn loại thời gian -->
                                            <div class="mb-3">
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="period_type" id="week_type" value="week" {% if period_type == 'week' %}checked{% endif %}>
                                                    <label class="btn btn-outline-primary" for="week_type">Tuần</label>
                                                    <input type="radio" class="btn-check" name="period_type" id="month_type" value="month" {% if period_type == 'month' %}checked{% endif %}>
                                                    <label class="btn btn-outline-primary" for="month_type">Tháng</label>
                                                </div>
                                            </div>

                                            <!-- Điều hướng thời gian -->
                                            <div class="mb-3">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <button type="button" class="btn btn-outline-secondary" id="prevPeriod">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <div class="text-center flex-grow-1 mx-2">
                                                        <strong id="periodDisplay">Đang tải...</strong>
                                                    </div>
                                                    <button type="button" class="btn btn-outline-secondary" id="nextPeriod">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <div class="d-flex align-items-center gap-2">
                                                    <input type="date" name="date_from" id="date_from" class="form-control form-control-sm" value="{{ date_from or '' }}" readonly style="flex: 1;">
                                                    <span class="text-muted">~</span>
                                                    <input type="date" name="date_to" id="date_to" class="form-control form-control-sm" value="{{ date_to or '' }}" readonly style="flex: 1;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cột giữa: Nhóm -->
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="groups" class="form-label">Nhóm:</label>
                                                <select name="groups" id="groups" multiple class="form-control" size="6">
                                                    {% for group in groups %}
                                                        <option value="{{ group[0] }}" {% if group[0]|string in selected_groups %}selected{% endif %}>{{ group[1] }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cột phải: Nguồn dữ liệu -->
                                <div class="col-md-4">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">Tìm theo:</label>
                                                <div class="form-check">
                                                    <input type="radio" class="form-check-input" id="user_conduct" name="data_source" value="user_conduct" {% if data_source == 'user_conduct' %}checked{% endif %}>
                                                    <label class="form-check-label" for="user_conduct">Hạnh kiểm</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="radio" class="form-check-input" id="user_subjects" name="data_source" value="user_subjects" {% if data_source == 'user_subjects' %}checked{% endif %}>
                                                    <label class="form-check-label" for="user_subjects">Học tập</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="radio" class="form-check-input" id="all" name="data_source" value="all" {% if data_source == 'all' or not data_source %}checked{% endif %}>
                                                    <label class="form-check-label" for="all">Tất cả</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12 text-center">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Tìm kiếm
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="card">
                    <div class="card-body">
                        <div id="table-container" class="table-responsive">
                            <table class="table table-bordered table-striped">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="text-nowrap">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="group_name" data-order="{{ 'desc' if sort_by == 'group_name' and sort_order == 'asc' else 'asc' }}">
                                                Nhóm
                                                {% if sort_by == 'group_name' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th colspan="3" class="text-center">Kỳ Trước</th>
                                        <th colspan="3" class="text-center">Kỳ Sau</th>
                                        <th rowspan="2" class="text-nowrap">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="progress" data-order="{{ 'desc' if sort_by == 'progress' and sort_order == 'asc' else 'asc' }}">
                                                Tiến bộ
                                                {% if sort_by == 'progress' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="prev_study" data-order="{{ 'desc' if sort_by == 'prev_study' and sort_order == 'asc' else 'asc' }}">
                                                Học tập
                                                {% if sort_by == 'prev_study' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="prev_conduct" data-order="{{ 'desc' if sort_by == 'prev_conduct' and sort_order == 'asc' else 'asc' }}">
                                                Hạnh kiểm
                                                {% if sort_by == 'prev_conduct' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="prev_total" data-order="{{ 'desc' if sort_by == 'prev_total' and sort_order == 'asc' else 'asc' }}">
                                                Tổng
                                                {% if sort_by == 'prev_total' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="now_study" data-order="{{ 'desc' if sort_by == 'now_study' and sort_order == 'asc' else 'asc' }}">
                                                Học tập
                                                {% if sort_by == 'now_study' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="now_conduct" data-order="{{ 'desc' if sort_by == 'now_conduct' and sort_order == 'asc' else 'asc' }}">
                                                Hạnh kiểm
                                                {% if sort_by == 'now_conduct' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                        <th class="text-center">
                                            <a href="#" class="sort-link text-decoration-none text-dark" data-sort="now_total" data-order="{{ 'desc' if sort_by == 'now_total' and sort_order == 'asc' else 'asc' }}">
                                                Tổng
                                                {% if sort_by == 'now_total' %}
                                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                                {% else %}
                                                    <i class="fas fa-sort"></i>
                                                {% endif %}
                                            </a>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in records %}
                                        <tr>
                                            <td>{{ record[0] }}</td>
                                            <td class="text-center">{{ record[2] }}</td>
                                            <td class="text-center">{{ record[3] }}</td>
                                            <td class="text-center">{{ record[1] }}</td>
                                            <td class="text-center">{{ record[5] }}</td>
                                            <td class="text-center">{{ record[6] }}</td>
                                            <td class="text-center">{{ record[4] }}</td>
                                            <td class="text-center">
                                                {% if record[7] > 0 %}
                                                    <span class="text-success">+{{ record[7] }}</span>
                                                {% elif record[7] < 0 %}
                                                    <span class="text-danger">{{ record[7] }}</span>
                                                {% else %}
                                                    <span class="text-muted">{{ record[7] }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Biến toàn cục cho việc quản lý thời gian
        let currentDate = new Date();
        let currentPeriodType = 'week';
        let isCollapsed = false; // Global variable for collapse state

        // Hàm lấy thứ Hai của tuần
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Điều chỉnh cho Chủ Nhật
            return new Date(d.setDate(diff));
        }

        // Hàm lấy ngày đầu tháng
        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        // Hàm lấy ngày cuối tháng
        function getLastDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0);
        }

        // Hàm format ngày về yyyy-mm-dd
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Hàm cập nhật hiển thị thời gian
        function updatePeriodDisplay() {
            const periodDisplay = document.getElementById('periodDisplay');
            const dateFromInput = document.getElementById('date_from');
            const dateToInput = document.getElementById('date_to');

            if (currentPeriodType === 'week') {
                const monday = getMonday(currentDate);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);

                dateFromInput.value = formatDate(monday);
                dateToInput.value = formatDate(sunday);

                const weekNumber = getWeekNumber(monday);
                periodDisplay.textContent = `Tuần ${weekNumber} - ${monday.getFullYear()}`;
            } else {
                const firstDay = getFirstDayOfMonth(currentDate);
                const lastDay = getLastDayOfMonth(currentDate);

                dateFromInput.value = formatDate(firstDay);
                dateToInput.value = formatDate(lastDay);

                const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                                   'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                periodDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
        }

        // Hàm lấy số tuần trong năm
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Biến để theo dõi việc khởi tạo
        let isInitializing = true;

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded for group_summary');
            
            var toggleButton = document.getElementById('toggleSearchForm');
            var searchFormCard = document.getElementById('searchFormCard');
            var isCollapsed = localStorage.getItem('groupSummarySearchCollapsed') === 'true';
            
            console.log('Toggle button:', toggleButton);
            console.log('Search form card:', searchFormCard);
            console.log('Initial collapsed state:', isCollapsed);
            
            // Apply initial state
            if (isCollapsed) {
                searchFormCard.style.maxHeight = '0px';
                searchFormCard.style.opacity = '0';
                console.log('Applied collapsed state');
            } else {
                searchFormCard.style.maxHeight = '500px';
                searchFormCard.style.opacity = '1';
                console.log('Applied expanded state');
            }

            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Toggle search form
            if (toggleButton && searchFormCard) {
                console.log('Setting up toggle functionality');
                
                toggleButton.addEventListener('click', function(e) {
                    console.log('Toggle button clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    
                    isCollapsed = !isCollapsed;
                    console.log('New collapsed state:', isCollapsed);
                    
                    if (isCollapsed) {
                        searchFormCard.style.maxHeight = '0px';
                        searchFormCard.style.opacity = '0';
                        console.log('Collapsing form');
                    } else {
                        searchFormCard.style.maxHeight = '500px';
                        searchFormCard.style.opacity = '1';
                        console.log('Expanding form');
                    }
                    
                    localStorage.setItem('groupSummarySearchCollapsed', isCollapsed);
                });
            } else {
                console.error('Toggle elements not found:', {toggleButton, searchFormCard});
            }
            
            // Kiểm tra xem có giá trị date_from và date_to từ server không
            const dateFromValue = document.getElementById('date_from').value;
            const dateToValue = document.getElementById('date_to').value;
            
            // Lấy period_type từ server
            const serverPeriodType = '{{ period_type }}';
            
            if (dateFromValue && dateToValue) {
                // Nếu có giá trị từ server, sử dụng giá trị đó
                const fromDate = new Date(dateFromValue);
                const toDate = new Date(dateToValue);
                
                // Sử dụng period_type từ server
                currentPeriodType = serverPeriodType || 'week';
                
                if (currentPeriodType === 'week') {
                    // Tuần: sử dụng ngày đầu tuần
                    currentDate = getMonday(fromDate);
                    document.getElementById('week_type').checked = true;
                } else {
                    // Tháng: sử dụng ngày đầu tháng  
                    currentDate = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
                    document.getElementById('month_type').checked = true;
                }
            } else {
                // Nếu không có giá trị từ server, khởi tạo với tuần hiện tại
                currentDate = getMonday(new Date());
                currentPeriodType = 'week';
                document.getElementById('week_type').checked = true;
            }
            
            updatePeriodDisplay();
            
            // Hoàn thành khởi tạo
            isInitializing = false;

            // Xử lý thay đổi loại thời gian
            document.querySelectorAll('input[name="period_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentPeriodType = this.value;
                    updatePeriodDisplay();
                });
            });

            // Xử lý nút lùi
            document.getElementById('prevPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    currentDate.setDate(currentDate.getDate() - 7);
                } else {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                }
                updatePeriodDisplay();
            });

            // Xử lý nút tiến
            document.getElementById('nextPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                updatePeriodDisplay();
            });

            // Tự động submit form khi thay đổi ngày (chỉ sau khi khởi tạo xong)
            document.getElementById('date_from').addEventListener('change', function() {
                if (!isInitializing) {
                    document.getElementById('searchForm').submit();
                }
            });
            document.getElementById('date_to').addEventListener('change', function() {
                if (!isInitializing) {
                    document.getElementById('searchForm').submit();
                }
            });
            
            // ===== AJAX SORTING LOGIC =====
            // Add event listeners for sort links
            document.querySelectorAll('.sort-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const sortBy = this.getAttribute('data-sort');
                    const sortOrder = this.getAttribute('data-order');
                    
                    console.log('Sort clicked:', sortBy, sortOrder);
                    
                    // Get form data
                    const form = document.getElementById('searchForm');
                    const formData = new FormData(form);
                    
                    // Add sort parameters
                    formData.append('sort_by', sortBy);
                    formData.append('sort_order', sortOrder);
                    
                    // Make AJAX request
                    fetch('{{ url_for("group_summary") }}', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.html) {
                            // Update table content
                            document.getElementById('table-container').innerHTML = data.html;
                            
                            // Re-attach event listeners to new sort links
                            attachSortListeners();
                            
                            console.log('Table updated successfully');
                        } else {
                            console.error('Failed to update table:', data);
                        }
                    })
                    .catch(error => {
                        console.error('AJAX Error:', error);
                    });
                });
            });
            
            // Function to re-attach sort listeners after AJAX update
            function attachSortListeners() {
                document.querySelectorAll('.sort-link').forEach(link => {
                    // Remove existing listeners by cloning the element
                    const newLink = link.cloneNode(true);
                    link.parentNode.replaceChild(newLink, link);
                    
                    // Add fresh event listener
                    newLink.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        const sortBy = this.getAttribute('data-sort');
                        const sortOrder = this.getAttribute('data-order');
                        
                        console.log('Sort clicked (re-attached):', sortBy, sortOrder);
                        
                        // Get form data
                        const form = document.getElementById('searchForm');
                        const formData = new FormData(form);
                        
                        // Add sort parameters
                        formData.append('sort_by', sortBy);
                        formData.append('sort_order', sortOrder);
                        
                        // Make AJAX request
                        fetch('{{ url_for("group_summary") }}', {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.html) {
                                // Update table content
                                document.getElementById('table-container').innerHTML = data.html;
                                
                                // Re-attach event listeners again
                                attachSortListeners();
                                
                                console.log('Table updated successfully (re-attached)');
                            } else {
                                console.error('Failed to update table (re-attached):', data);
                            }
                        })
                        .catch(error => {
                            console.error('AJAX Error (re-attached):', error);
                        });
                    });
                });
            }
        });
    </script>
{% endblock %}