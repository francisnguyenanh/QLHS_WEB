{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Danh sách học sinh</h2>
        
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-success" onclick="openCreateModal()">Tạo mới</button>
                    <a href="{{ url_for('static', filename='student.xlsx') }}" class="btn btn-secondary" download="student_template.xlsx">
                        <i class="fas fa-download me-1"></i>Tải danh sách mẫu
                    </a>
                    <button type="button" class="btn btn-info" onclick="openUploadModal()">
                        <i class="fas fa-upload me-1"></i>Upload danh sách
                    </button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='first_name', sort_order='desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc') }}">
                                Tên
                                {% if sort_by == 'first_name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">Họ và tên đệm</th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='username', sort_order='desc' if sort_by == 'username' and sort_order == 'asc' else 'asc') }}">
                                Tên đăng nhập
                                {% if sort_by == 'username' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='group_name', sort_order='desc' if sort_by == 'group_name' and sort_order == 'asc' else 'asc') }}">
                                Nhóm
                                {% if sort_by == 'group_name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='role_name', sort_order='desc' if sort_by == 'role_name' and sort_order == 'asc' else 'asc') }}">
                                Chức vụ
                                {% if sort_by == 'role_name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        {% set name_parts = user[1].split() %}
                        {% set first_name = name_parts[-1] if name_parts|length > 0 else '' %}
                        {% set last_name = ' '.join(name_parts[:-1]) if name_parts|length > 1 else '' %}
                        <tr>
                            <td>{{ first_name }}</td>
                            <td>{{ last_name }}</td>
                            <td>{{ user[2] }}</td>
                            <td>{{ user[5] or 'None' }}</td>
                            <td>{{ user[4] or 'None' }}</td>
                            <td class="text-nowrap">
                                {% if user[4] == 'Master' %}
                                    <button class="btn btn-sm btn-secondary me-1" disabled title="Không thể sửa user Master">Sửa</button>
                                    <button class="btn btn-sm btn-secondary" disabled title="Không thể xóa user Master">Xoá</button>
                                {% elif user[4] == 'GVCN' %}
                                <button class="btn btn-sm btn-primary me-1" onclick="openEditModal({{ user[0] }})">Sửa</button>
                                    <button class="btn btn-sm btn-secondary" disabled title="Không thể xóa user GVCN">Xoá</button>
                                {% else %}
                                    <button class="btn btn-sm btn-primary me-1" onclick="openEditModal({{ user[0] }})">Sửa</button>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDelete('Bạn có chắc chắn muốn xóa user này?', () => deleteItem('{{ url_for('user_delete', id=user[0]) }}'))">Xoá</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Tạo mới học sinh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Họ tên *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3" id="group_field">
                                <label for="group_id" class="form-label">Nhóm</label>
                                <select class="form-select" id="group_id" name="group_id">
                                    <option value="">Chọn nhóm</option>
                                    {% for group in groups %}
                                        <option value="{{ group[0] }}">{{ group[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">Tên đăng nhập *</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Mật khẩu *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                            
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3" id="role_field">
                                <label for="role_id" class="form-label">Chức vụ</label>
                                <select class="form-select" id="role_id" name="role_id" onchange="handleRoleChange()">
                                    <option value="">Chọn chức vụ</option>
                                    {% for role in roles %}
                                        {% if role[1] not in ['Master', 'GVCN'] %}
                                            <option value="{{ role[0] }}">{{ role[1] }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row" id="role_credentials_fields" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label for="role_username" class="form-label">Tên đăng nhập (chức vụ) *</label>
                                <input type="text" class="form-control" id="role_username" name="role_username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="role_password" class="form-label">Mật khẩu (chức vụ) *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="role_password" name="role_password">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleRolePassword()">
                                        <i class="fas fa-eye" id="toggleRolePasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Excel Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Upload File Excel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        ① Hãy tải danh sách mẫu để điển tên học sinh<br>
                        ② Upload danh sách học sinh đúng định dạng đã tải<br>
                        <small class="text-muted">
                            * Tên đăng nhập và Mật khẩu: sẽ được tạo từ Tên + số ngẫu nhiên (vd: Anh23)<br>
                            * Tất cả tài khoản sẽ có chức vụ Học sinh<br>
                            * Cần chọn nhóm cho học sinh sau khi tạo<br>
                        </small>
                    </div>
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="excelFile" class="form-label">Chọn file Excel *</label>
                            <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="uploadExcel()">
                        <i class="fas fa-upload me-1"></i>Upload
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @media (max-width: 768px) {
            .table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.5rem !important;
            }
            .btn {
                margin-bottom: 0.5rem;
            }
        }
    </style>

    <script>
        let isEditMode = false;
        let editUserId = null;

        function openCreateModal() {
            isEditMode = false;
            editUserId = null;
            document.getElementById('userModalLabel').textContent = 'Tạo mới học sinh';
            document.getElementById('userForm').reset();
            document.getElementById('password').required = true;
            // Show and enable all fields for create mode
            document.getElementById('group_field').style.display = 'block';
            document.getElementById('role_field').style.display = 'block';
            document.getElementById('group_id').disabled = false;
            document.getElementById('role_id').disabled = false;
            // Hide role credentials initially
            document.getElementById('role_credentials_fields').style.display = 'none';
            document.getElementById('role_username').required = false;
            document.getElementById('role_password').required = false;
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function handleRoleChange() {
            const roleSelect = document.getElementById('role_id');
            const selectedRoleId = roleSelect.value;
            const roleCredentialsFields = document.getElementById('role_credentials_fields');
            const roleUsernameField = document.getElementById('role_username');
            const rolePasswordField = document.getElementById('role_password');
            
            if (selectedRoleId) {
                // Get role name to check if it's "Học sinh" or role ID = 9
                const selectedOption = roleSelect.querySelector(`option[value="${selectedRoleId}"]`);
                const roleName = selectedOption ? selectedOption.textContent : '';
                
                if (roleName === 'Học sinh' || selectedRoleId === '9') {
                    // Hide role credentials fields for student role or role ID 9
                    roleCredentialsFields.style.display = 'none';
                    roleUsernameField.required = false;
                    rolePasswordField.required = false;
                    // Clear the values when switching to role ID 9
                    roleUsernameField.value = '';
                    rolePasswordField.value = '';
                } else {
                    // Show role credentials fields for non-student roles
                    roleCredentialsFields.style.display = 'block';
                    roleUsernameField.required = true;
                    rolePasswordField.required = true;
                }
            } else {
                // No role selected, hide fields
                roleCredentialsFields.style.display = 'none';
                roleUsernameField.required = false;
                rolePasswordField.required = false;
                roleUsernameField.value = '';
                rolePasswordField.value = '';
            }
        }

        function checkUserRole(roleId) {
            // Check if user has GVCN role by getting role name
            const roleSelect = document.getElementById('role_id');
            const selectedOption = roleSelect.querySelector(`option[value="${roleId}"]`);
            return selectedOption ? selectedOption.textContent === 'GVCN' : false;
        }

        function openEditModal(userId) {
            isEditMode = true;
            editUserId = userId;
            document.getElementById('userModalLabel').textContent = 'Chỉnh sửa học sinh';
            document.getElementById('password').required = false;
            // Load user data
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showError(data.error);
                        return;
                    }
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('username').value = data.username || '';
                    document.getElementById('password').value = data.password || '';
                    document.getElementById('group_id').value = data.group_id || '';
                    document.getElementById('role_id').value = data.role_id || '';
                    document.getElementById('role_username').value = data.role_username || '';
                    document.getElementById('role_password').value = data.role_password || '';
                    
                    // Check if current user has GVCN role (need to get role name from backend)
                    fetch(`/api/roles/${data.role_id}`)
                        .then(response => response.json())
                        .then(roleData => {
                            if (roleData.name === 'GVCN') {
                                // Hide group and role selection for GVCN users
                                document.getElementById('group_field').style.display = 'none';
                                document.getElementById('role_field').style.display = 'none';
                                document.getElementById('role_credentials_fields').style.display = 'none';
                            } else {
                                // Show and enable fields for non-GVCN users
                                document.getElementById('group_field').style.display = 'block';
                                document.getElementById('role_field').style.display = 'block';
                                document.getElementById('group_id').disabled = false;
                                document.getElementById('role_id').disabled = false;
                                // Handle role credentials visibility
                                handleRoleChange();
                            }
                        })
                        .catch(error => {
                            console.error('Error loading role data:', error);
                            // Default to showing fields if can't load role data
                            document.getElementById('group_field').style.display = 'block';
                            document.getElementById('role_field').style.display = 'block';
                            document.getElementById('group_id').disabled = false;
                            document.getElementById('role_id').disabled = false;
                            handleRoleChange();
                        });
                    
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function saveUser() {
            const form = document.getElementById('userForm');
            const formData = new FormData(form);
            
            // Validate required fields
            if (!formData.get('name') || !formData.get('username')) {
                showWarning('Vui lòng nhập đầy đủ thông tin bắt buộc');
                return;
            }
            if (!isEditMode && !formData.get('password')) {
                showWarning('Vui lòng nhập mật khẩu');
                return;
            }
            
            // Check if role credentials are required
            const roleSelect = document.getElementById('role_id');
            const selectedRoleId = roleSelect.value;
            const roleCredentialsVisible = document.getElementById('role_credentials_fields').style.display !== 'none';
            
            if (roleCredentialsVisible && selectedRoleId) {
                const selectedOption = roleSelect.querySelector(`option[value="${selectedRoleId}"]`);
                const roleName = selectedOption ? selectedOption.textContent : '';
                
                if (roleName !== 'Học sinh' && selectedRoleId !== '9') {
                    if (!formData.get('role_username') || !formData.get('role_password')) {
                        showWarning('Vui lòng nhập đầy đủ Tên đăng nhập (chức vụ) và Mật khẩu (chức vụ) cho chức vụ này');
                        return;
                    }
                }
            }
            
            // Check if fields are hidden (for GVCN users)
            const groupField = document.getElementById('group_field');
            const roleField = document.getElementById('role_field');
            const groupSelect = document.getElementById('group_id');
            
            const data = {
                name: formData.get('name'),
                username: formData.get('username'),
                password: formData.get('password'),
                class_id: null,
                group_id: (groupField.style.display === 'none') ? null : (formData.get('group_id') || null),
                role_id: (roleField.style.display === 'none') ? null : (formData.get('role_id') || null),
                role_username: (selectedRoleId === '9') ? null : (formData.get('role_username') || null),
                role_password: (selectedRoleId === '9') ? null : (formData.get('role_password') || null)
            };
            
            // For edit mode, if fields are hidden, keep current values
            if (isEditMode && (groupField.style.display === 'none' || roleField.style.display === 'none')) {
                data.group_id = groupSelect.value || null;
                data.role_id = roleSelect.value || null;
            }
            
            const url = isEditMode ? `/api/users/${editUserId}` : '/api/users';
            const method = isEditMode ? 'PUT' : 'POST';
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                        showSuccess(data.message);
                        // Chờ toast hiển thị xong rồi mới reload (giả sử toast mặc định 2s)
                        setTimeout(function() {
                            location.reload();
                        }, 2000); // 2000ms = 2s, chỉnh theo thời gian toast
                } else {
                    showError(data.error || 'Có lỗi xảy ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Có lỗi xảy ra khi lưu dữ liệu');
            });
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('togglePasswordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        function toggleRolePassword() {
            const passwordInput = document.getElementById('role_password');
            const toggleIcon = document.getElementById('toggleRolePasswordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        function openUploadModal() {
            document.getElementById('uploadForm').reset();
            new bootstrap.Modal(document.getElementById('uploadModal')).show();
        }

        function uploadExcel() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const fileInput = document.getElementById('excelFile');
            
            if (!fileInput.files[0]) {
                showError('Vui lòng chọn file Excel');
                return;
            }
            
            // Kiểm tra định dạng file
            const fileName = fileInput.files[0].name;
            if (!fileName.match(/\.(xlsx|xls)$/i)) {
                showError('Vui lòng chọn file Excel (.xlsx hoặc .xls)');
                return;
            }
            
            fetch('/api/upload_users_excel', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    showSuccess(data.message + ` (${data.imported_count} học sinh đã được thêm)`);
                    setTimeout(function() {
                        location.reload();
                    }, 2000);
                } else {
                    showError(data.error || 'Có lỗi xảy ra khi upload file');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Có lỗi xảy ra khi upload file');
            });
        }

        document.getElementById('name').addEventListener('input', function() {
            const nameValue = this.value.trim();
            if (nameValue.length > 0) {
                fetch('/api/generate_user_credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: nameValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.username) {
                        document.getElementById('username').value = data.username;
                    }
                    if (data.password) {
                        document.getElementById('password').value = data.password;
                    }
                });
            } else {
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }
        });
    </script>
{% endblock %}