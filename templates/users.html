{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Danh sách học sinh</h2>
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" class="btn btn-success w-100 w-md-auto" onclick="openCreateModal()">Tạo mới</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='first_name', sort_order='desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc') }}">
                                Tên
                                {% if sort_by == 'first_name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">Họ và tên đệm</th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='username', sort_order='desc' if sort_by == 'username' and sort_order == 'asc' else 'asc') }}">
                                Tên đăng nhập
                                {% if sort_by == 'username' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='group_name', sort_order='desc' if sort_by == 'group_name' and sort_order == 'asc' else 'asc') }}">
                                Nhóm
                                {% if sort_by == 'group_name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('users_list', sort_by='role_name', sort_order='desc' if sort_by == 'role_name' and sort_order == 'asc' else 'asc') }}">
                                Chức vụ
                                {% if sort_by == 'role_name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        {% set name_parts = user[1].split() %}
                        {% set first_name = name_parts[-1] if name_parts|length > 0 else '' %}
                        {% set last_name = ' '.join(name_parts[:-1]) if name_parts|length > 1 else '' %}
                        <tr>
                            <td>{{ first_name }}</td>
                            <td>{{ last_name }}</td>
                            <td>{{ user[2] }}</td>
                            <td>{{ user[5] or 'None' }}</td>
                            <td>{{ user[4] or 'None' }}</td>
                            <td class="text-nowrap">
                                {% if user[4] == 'Master' %}
                                    <button class="btn btn-sm btn-secondary me-1" disabled title="Không thể sửa user Master">Sửa</button>
                                    <button class="btn btn-sm btn-secondary" disabled title="Không thể xóa user Master">Xoá</button>
                                {% else %}
                                    <button class="btn btn-sm btn-primary me-1" onclick="openEditModal({{ user[0] }})">Sửa</button>
                                    <a href="{{ url_for('user_delete', id=user[0]) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Xoá</a>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Tạo mới học sinh</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label">Họ tên *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="username" class="form-label">Tên đăng nhập *</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="password" class="form-label">Mật khẩu *</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="group_id" class="form-label">Nhóm</label>
                                <select class="form-select" id="group_id" name="group_id">
                                    <option value="">Chọn nhóm</option>
                                    {% for group in groups %}
                                        <option value="{{ group[0] }}">{{ group[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="role_id" class="form-label">Chức vụ</label>
                                <select class="form-select" id="role_id" name="role_id">
                                    <option value="">Chọn chức vụ</option>
                                    {% for role in roles %}
                                        <option value="{{ role[0] }}">{{ role[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        @media (max-width: 768px) {
            .table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.5rem !important;
            }
            .btn {
                margin-bottom: 0.5rem;
            }
        }
    </style>

    <script>
        let isEditMode = false;
        let editUserId = null;

        function openCreateModal() {
            isEditMode = false;
            editUserId = null;
            document.getElementById('userModalLabel').textContent = 'Tạo mới học sinh';
            document.getElementById('userForm').reset();
            document.getElementById('password').required = true;
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function openEditModal(userId) {
            isEditMode = true;
            editUserId = userId;
            document.getElementById('userModalLabel').textContent = 'Chỉnh sửa học sinh';
            document.getElementById('password').required = false;
            // Load user data
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    document.getElementById('name').value = data.name || '';
                    document.getElementById('username').value = data.username || '';
                    document.getElementById('password').value = '';
                    document.getElementById('group_id').value = data.group_id || '';
                    document.getElementById('role_id').value = data.role_id || '';
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function saveUser() {
            const form = document.getElementById('userForm');
            const formData = new FormData(form);
            // Validate required fields
            if (!formData.get('name') || !formData.get('username')) {
                alert('Vui lòng nhập đầy đủ thông tin bắt buộc');
                return;
            }
            if (!isEditMode && !formData.get('password')) {
                alert('Vui lòng nhập mật khẩu');
                return;
            }
            const data = {
                name: formData.get('name'),
                username: formData.get('username'),
                password: formData.get('password'),
                class_id: null,
                group_id: formData.get('group_id') || null,
                role_id: formData.get('role_id') || null
            };
            const url = isEditMode ? `/api/users/${editUserId}` : '/api/users';
            const method = isEditMode ? 'PUT' : 'POST';
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    location.reload();
                } else {
                    alert(data.error || 'Có lỗi xảy ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi lưu dữ liệu');
            });
        }

        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('togglePasswordIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }
    </script>
{% endblock %}