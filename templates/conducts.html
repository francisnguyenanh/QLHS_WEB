{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Danh sách hạnh kiểm</h2>
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" class="btn btn-success w-100 w-md-auto" onclick="openCreateModal()">Tạo mới</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th class="text-nowrap">
                            <a href="{{ url_for('conducts_list', sort_by='name', sort_order='desc' if sort_by == 'name' and sort_order == 'asc' else 'asc') }}">
                                Tên hạnh kiểm
                                {% if sort_by == 'name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('conducts_list', sort_by='conduct_type', sort_order='desc' if sort_by == 'conduct_type' and sort_order == 'asc' else 'asc') }}">
                                Loại hạnh kiểm
                                {% if sort_by == 'conduct_type' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('conducts_list', sort_by='conduct_points', sort_order='desc' if sort_by == 'conduct_points' and sort_order == 'asc' else 'asc') }}">
                                Điểm hạnh kiểm
                                {% if sort_by == 'conduct_points' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for conduct in conducts %}
                        <tr>
                            <td>{{ conduct[1] }}</td>
                            <td>{{ conduct[2] or 'N/A' }}</td>
                            <td>{{ conduct[3] }}</td>
                            <td class="text-nowrap">
                                <button class="btn btn-sm btn-primary me-1" onclick="openEditModal({{ conduct[0] }})">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('Bạn có chắc chắn muốn xóa hạnh kiểm này?', () => deleteItem('{{ url_for('conduct_delete', id=conduct[0]) }}'))">Xoá</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Create/Edit -->
    <div class="modal fade" id="conductModal" tabindex="-1" aria-labelledby="conductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="conductModalLabel">Tạo hạnh kiểm mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="conductForm">
                        <input type="hidden" id="modal_id" name="id">
                        <div class="mb-3">
                            <label for="modal_name" class="form-label">Tên hạnh kiểm:</label>
                            <input type="text" name="name" id="modal_name" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="modal_conduct_type" class="form-label">Loại hạnh kiểm:</label>
                            <input type="text" name="conduct_type" id="modal_conduct_type" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="modal_conduct_points" class="form-label">Điểm hạnh kiểm:</label>
                            <input type="number" name="conduct_points" id="modal_conduct_points" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="saveConduct()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let currentEditId = null;

        function openCreateModal() {
            isEditMode = false;
            currentEditId = null;
            document.getElementById('conductModalLabel').textContent = 'Tạo hạnh kiểm mới';
            document.getElementById('conductForm').reset();
            document.getElementById('modal_id').value = '';
            const modal = new bootstrap.Modal(document.getElementById('conductModal'));
            modal.show();
        }

        function openEditModal(id) {
            isEditMode = true;
            currentEditId = id;
            document.getElementById('conductModalLabel').textContent = 'Chỉnh sửa hạnh kiểm';
            
            // Fetch record data
            fetch(`/api/conducts/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modal_id').value = data.id;
                    document.getElementById('modal_name').value = data.name;
                    document.getElementById('modal_conduct_type').value = data.conduct_type;
                    document.getElementById('modal_conduct_points').value = data.conduct_points;
                    
                    const modal = new bootstrap.Modal(document.getElementById('conductModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching record:', error);
                    showError('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function saveConduct() {
            const form = document.getElementById('conductForm');
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                conduct_type: formData.get('conduct_type'),
                conduct_points: formData.get('conduct_points')
            };

            // Validate required fields
            if (!data.name || !data.conduct_type || !data.conduct_points) {
                showWarning('Vui lòng điền đầy đủ thông tin');
                return;
            }

            const url = isEditMode ? `/api/conducts/${currentEditId}` : '/api/conducts';
            const method = isEditMode ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Đóng modal trước khi hiển thị toast
                    const modal = bootstrap.Modal.getInstance(document.getElementById('conductModal'));
                    if (modal) {
                        modal.hide();
                    }
                    showSuccess(result.message);
                    setTimeout(function() {
                        location.reload(); // Reload page to show updated data
                    }, 2000);
                } else {
                    showError('Có lỗi xảy ra: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving conduct:', error);
                showError('Có lỗi xảy ra khi lưu dữ liệu');
            });
        }

        function deleteItem(url) {
            // Hiển thị toast thành công trước
            showSuccess('Đang xóa...');
            // Delay redirect để toast hiển thị
            setTimeout(function() {
                window.location.href = url;
            }, 1000); // 1 giây để hiển thị toast "Đang xóa..."
        }
    </script>

    <style>
        @media (max-width: 768px) {
            .table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.5rem !important;
            }
            .btn {
                margin-bottom: 0.5rem;
            }
        }
    </style>
{% endblock %}