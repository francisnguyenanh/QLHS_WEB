{% extends "base.html" %}

{% block extra_css %}
<style>
    /* Table improvements */
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    .prev-period-data {
        color: #6c757d;
        font-size: 0.875em;
        font-style: italic;
    }

    /* Misc */
    .save-status {
        min-width: 80px;
        display: inline-block;
        white-space: nowrap;
    }
    .auto-save-comment {
        resize: vertical;
    }
    .auto-save-comment:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    /* Toggle button and search form styling */
    .btn-compact {
        padding: 8px 12px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        min-width: 40px;
    }
    .btn-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-compact.btn-success {
        background: linear-gradient(135deg, #198754, #20c997);
        border: none;
        color: white;
    }
    .btn-compact.btn-primary {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        border: none;
        color: white;
    }
    .btn-compact.active {
        background: linear-gradient(135deg, #6610f2, #0d6efd);
        transform: scale(1.05);
    }

    /* Search form card styling */
    .search-form-card {
        margin-bottom: 20px;
        border: none;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: max-height 0.3s, opacity 0.3s;
        max-height: 500px;
        opacity: 1;
    }
    .search-form-card.collapsed {
        max-height: 0 !important;
        opacity: 0 !important;
        overflow: hidden !important;
        margin-bottom: 0 !important;
        padding: 0 !important;
        border: none !important;
        box-shadow: none !important;
        transition: max-height 0.3s, opacity 0.3s;
    }
    .search-form-card.collapsed .card-body {
        padding: 0;
    }
    .search-form-card .card-body {
        padding: 20px;
        transition: padding 0.3s ease;
    }
    .search-form-card .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .search-form-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }
    .search-form-card .card-header h6 {
        color: #495057;
        font-weight: 600;
    }

    /* Animation for collapse/expand */
    @keyframes slideDown {
        from {
            max-height: 0;
            opacity: 0;
        }
        to {
            max-height: 500px;
            opacity: 1;
        }
    }
    @keyframes slideUp {
        from {
            max-height: 500px;
            opacity: 1;
        }
        to {
            max-height: 0;
            opacity: 0;
        }
    }
    .search-form-card.expanding {
        animation: slideDown 0.3s ease-out forwards;
    }
    .search-form-card.collapsing {
        animation: slideUp 0.3s ease-out forwards;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .row.g-3 > .col-12.col-md-4 {
            height: fit-content;
            min-height: 100%;
        }
        .d-flex.gap-2 {
            flex-wrap: wrap;
            gap: 8px !important;
        }
        .search-form-card .row {
            flex-direction: column;
        }
        .search-form-card .col-md-4 {
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        select[multiple] {
            height: auto !important;
        }
        .btn {
            margin-bottom: 0.5rem;
        }
        .table {
            font-size: 0.7rem;
        }
        th, td {
            padding: 0.5rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-12">
            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Tổng Kết Học Sinh</h2>
                
                <!-- Buttons -->
                <div class="d-flex gap-2">
                    <form method="POST" action="{{ url_for('print_users') }}" id="printForm" style="display: inline;">
                        <input type="hidden" name="selected_users" id="selected_users_input">
                        <input type="hidden" name="date_from" id="date_from_input" value="{{ date_from or '' }}">
                        <input type="hidden" name="date_to" id="date_to_input" value="{{ date_to or '' }}">
                        <!--
                        <button type="submit" class="btn btn-success btn-compact" data-bs-toggle="tooltip" title="Xuất phiếu báo cáo">
                            <i class="fas fa-print"></i>
                            <span class="d-none d-md-inline ms-1">Xuất phiếu</span>
                        </button>
                    -->
                    </form>
                    <button type="button" class="btn btn-warning btn-compact" id="loadRankingBtn" data-bs-toggle="tooltip" title="Nhập xếp loại">
                        <i class="fas fa-star"></i>
                        <span class="d-none d-md-inline ms-1">Xếp loại</span>
                    </button>
                    <button type="button" class="btn btn-success btn-compact" id="loadCommentsBtn" data-bs-toggle="tooltip" title="Nhập nhận xét">
                        <i class="fas fa-comments"></i>
                        <span class="d-none d-md-inline ms-1">Nhận xét</span>
                    </button>
                    <button type="button" class="btn btn-primary btn-compact" id="toggleSearchForm" data-bs-toggle="tooltip" title="Hiện/Ẩn điều kiện tìm kiếm">
                        <i class="fas fa-filter"></i>
                        <span class="d-none d-md-inline ms-1">Bộ lọc</span>
                    </button>
                </div>
            </div>

            <!-- Search Form Card -->
            <div class="card search-form-card" id="searchFormCard">
                <div class="card-body">
                    <form method="POST" id="searchForm">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <!-- Chọn loại thời gian -->
                                <div class="form-group mb-3">
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="period_type" id="week_type" value="week" checked>
                                        <label class="btn btn-outline-primary" for="week_type">Tuần</label>
                                        <input type="radio" class="btn-check" name="period_type" id="month_type" value="month">
                                        <label class="btn btn-outline-primary" for="month_type">Tháng</label>
                                    </div>
                                </div>

                                <!-- Điều hướng thời gian -->
                                <div class="form-group mb-3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary" id="prevPeriod">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <div class="text-center flex-grow-1 mx-2">
                                            <strong id="periodDisplay">Đang tải...</strong>
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary" id="nextPeriod">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="date" name="date_from" id="date_from" class="form-control form-control-sm" value="{{ date_from or '' }}" readonly style="flex: 1;">
                                        <span class="text-muted">~</span>
                                        <input type="date" name="date_to" id="date_to" class="form-control form-control-sm" value="{{ date_to or '' }}" readonly style="flex: 1;">
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    <label for="users">Học sinh:</label>
                                    <select name="users" id="users" multiple class="form-control" size="6">
                                        {% for user in users %}
                                            <option value="{{ user[0] }}" {% if user[0]|string in selected_users %}selected{% endif %}>{{ user[1] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% if role_name == 'GVCN' or role_name == 'Master' %}
                            <div class="col-12 col-md-4">
                                <div class="form-group">
                                    <label for="groups">Nhóm:</label>
                                    <select name="groups" id="groups" multiple class="form-control" size="6">
                                        {% for group in groups %}
                                            <option value="{{ group.id }}" {% if group.id|string in selected_groups %}selected{% endif %}>{{ group.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Table -->
            <div class="card">
                <div class="card-body">
                    <div id="gridContainer">
                        
                        {% if not records %}
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle"></i> Không có dữ liệu phù hợp với điều kiện tìm kiếm.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        // Biến toàn cục cho việc quản lý thời gian
        let currentDate = new Date();
        let currentPeriodType = 'week';
        let isInitializing = true;
        let isCollapsed = false; // Global variable for collapse state

        // Hàm lấy tuần hiện tại từ backend
        async function loadCurrentWeek() {
            const today = new Date();
            const todayStr = today.toISOString().slice(0, 10);
            try {
                const res = await fetch(`/api/week_by_date?date=${todayStr}`);
                const data = await res.json();
                if (res.ok && !data.error) {
                    document.getElementById('date_from').value = data.from_date;
                    document.getElementById('date_to').value = data.to_date;
                    document.getElementById('periodDisplay').textContent = `Tuần ${data.week_number}`;
                    window.currentWeekNumber = data.week_number;
                } else {
                    showError(data.error || 'Không lấy được dữ liệu tuần');
                }
            } catch (error) {
                showError('Không thể kết nối tới máy chủ');
            }
        }

        // Hàm chuyển tuần (lùi/tới)
        async function changeWeek(direction) {
            let week = window.currentWeekNumber || 1;
            week = direction === 'next' ? week + 1 : week - 1;
            try {
                const res = await fetch(`/api/week_by_number?week_number=${week}`);
                const data = await res.json();
                if (res.ok && !data.error) {
                    document.getElementById('date_from').value = data.from_date;
                    document.getElementById('date_to').value = data.to_date;
                    document.getElementById('periodDisplay').textContent = `Tuần ${data.week_number}`;
                    window.currentWeekNumber = data.week_number;
                } else {
                    showError(data.error || 'Không lấy được dữ liệu tuần');
                }
            } catch (error) {
                showError('Không thể kết nối tới máy chủ');
            }
        }

        // Hàm lấy ngày đầu tháng
        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        // Hàm lấy ngày cuối tháng
        function getLastDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0);
        }

        // Hàm format ngày về yyyy-mm-dd
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }


        // Hàm cập nhật hiển thị thời gian
        async function updatePeriodDisplay() {
            const periodDisplay = document.getElementById('periodDisplay');
            const dateFromInput = document.getElementById('date_from');
            const dateToInput = document.getElementById('date_to');

            if (currentPeriodType === 'week') {
            }  else { // month
                const firstDay = getFirstDayOfMonth(currentDate);
                const lastDay = getLastDayOfMonth(currentDate);

                dateFromInput.value = formatDate(firstDay);
                dateToInput.value = formatDate(lastDay);

                const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                                   'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                periodDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
            
            // Load new data after period change
            if (!isInitializing) {
                loadData();
            }
        }

        // Toggle search form functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded for user_summary');
            
            // ===== TOGGLE SEARCH FORM LOGIC =====
            const toggleSearchForm = document.getElementById('toggleSearchForm');
            const searchFormCard = document.getElementById('searchFormCard');
            let isCollapsed = false;
            
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Toggle search form
            if (toggleSearchForm && searchFormCard) {
                toggleSearchForm.addEventListener('click', function() {
                    console.log('Toggle clicked, isCollapsed:', isCollapsed);
                    if (isCollapsed) {
                        console.log('Expanding...');
                        // Expand
                        searchFormCard.classList.remove('collapsed', 'collapsing');
                        searchFormCard.classList.add('expanding');
                        this.classList.add('active');
                        this.innerHTML = '<i class="fas fa-eye-slash"></i><span class="d-none d-md-inline ms-1">Ẩn lọc</span>';
                        isCollapsed = false;
                        
                        // Remove animation class after animation completes
                        setTimeout(() => {
                            searchFormCard.classList.remove('expanding');
                            console.log('Expanded, classes:', searchFormCard.classList.toString());
                        }, 300);
                    } else {
                        // Collapse
                        console.log('Collapsing...');
                        searchFormCard.classList.remove('expanding');
                        searchFormCard.classList.add('collapsing');
                        this.classList.remove('active');
                        this.innerHTML = '<i class="fas fa-filter"></i><span class="d-none d-md-inline ms-1">Bộ lọc</span>';
                        
                        // Add collapsed class after animation completes
                        setTimeout(() => {
                            searchFormCard.classList.remove('collapsing');
                            searchFormCard.classList.add('collapsed');
                            isCollapsed = true;
                            console.log('Collapsed, classes:', searchFormCard.classList.toString());
                        }, 300);
                    }
                });
            }
            
            loadCurrentWeek();
            // Khởi tạo period display
            initializePeriodDisplay();
        });

        function initializePeriodDisplay() {
            // Kiểm tra xem có giá trị date_from và date_to từ server không
            const dateFromValue = document.getElementById('date_from').value;
            const dateToValue = document.getElementById('date_to').value;
            
            // Lấy period_type từ server
            const serverPeriodType = '{{ period_type }}';
            
            if (dateFromValue && dateToValue) {
                // Nếu có giá trị từ server, sử dụng giá trị đó
                const fromDate = new Date(dateFromValue);
                const toDate = new Date(dateToValue);
                
                // Sử dụng period_type từ server
                currentPeriodType = serverPeriodType || 'week';
                
                if (currentPeriodType === 'week') {
                    // Tuần: sử dụng ngày đầu tuần
                    document.getElementById('week_type').checked = true;
                } else {
                    // Tháng: sử dụng ngày đầu tháng  
                    currentDate = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
                    document.getElementById('month_type').checked = true;
                }
            } else {
                // Nếu không có giá trị từ server, khởi tạo với tuần hiện tại
                currentPeriodType = 'week';
                document.getElementById('week_type').checked = true;
            }
            
            updatePeriodDisplay();
            
            // Hoàn thành khởi tạo
            isInitializing = false;

            document.querySelectorAll('input[name="period_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentPeriodType = this.value;
                    if (currentPeriodType === 'week') {
                        loadCurrentWeek();
                    } else {
                        updatePeriodDisplay(); // Tháng giữ logic cũ
                    }
                });
            });

            document.getElementById('prevPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    changeWeek('prev');
                } else {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    updatePeriodDisplay();
                }
            });

            document.getElementById('nextPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    changeWeek('next');
                } else {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    updatePeriodDisplay();
                }
            });

            // AJAX form submission
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                loadData();
            });

            // Initialize table events and auto-save
            initializeTableEvents();
            initAutoSave();
        }

        // AJAX functionality for form submission
        function loadData() {
            const form = document.getElementById('searchForm');
            const formData = new FormData(form);
            
            fetch('{{ url_for("user_summary") }}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    document.getElementById('gridContainer').innerHTML = data.html;
                    // Re-initialize event listeners for new content
                    initializeTableEvents();
                    initAutoSave();
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
            });
        }

        // Initialize table events for dynamically loaded content
        function initializeTableEvents() {
            // Re-initialize select all checkbox
            const selectAllCheckbox = document.getElementById('select_all_in');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('input[name^="in_"]');
                    for (let i = 0; i < checkboxes.length; i++) {
                        checkboxes[i].checked = this.checked;
                    }
                });
            }

            // Initialize sort links
            document.querySelectorAll('.sort-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sortBy = this.getAttribute('data-sort');
                    const sortOrder = this.getAttribute('data-order');
                    
                    console.log('Sorting by:', sortBy, 'Order:', sortOrder);
                    
                    // Update form with sort parameters
                    const form = document.getElementById('searchForm');
                    
                    // Remove existing sort inputs
                    const existingSortBy = form.querySelector('input[name="sort_by"]');
                    const existingSortOrder = form.querySelector('input[name="sort_order"]');
                    if (existingSortBy) existingSortBy.remove();
                    if (existingSortOrder) existingSortOrder.remove();
                    
                    // Add new sort inputs
                    const sortByInput = document.createElement('input');
                    sortByInput.type = 'hidden';
                    sortByInput.name = 'sort_by';
                    sortByInput.value = sortBy;
                    form.appendChild(sortByInput);
                    
                    const sortOrderInput = document.createElement('input');
                    sortOrderInput.type = 'hidden';
                    sortOrderInput.name = 'sort_order';
                    sortOrderInput.value = sortOrder;
                    form.appendChild(sortOrderInput);
                    
                    // Load data with new sort
                    loadData();
                });
            });

            // Re-initialize user name clickable elements
            document.querySelectorAll('.user-name-clickable').forEach(element => {
                element.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    const dateFrom = this.getAttribute('data-date-from');
                    const dateTo = this.getAttribute('data-date-to');
                    
                    let reportUrl = `${window.location.origin}/user_report/${userId}`;
                    
                    // Thêm tham số ngày nếu có
                    const params = new URLSearchParams();
                    if (dateFrom) params.append('date_from', dateFrom);
                    if (dateTo) params.append('date_to', dateTo);
                    
                    if (params.toString()) {
                        reportUrl += '?' + params.toString();
                    }
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(reportUrl).then(function() {
                        // Mở tab mới với link vừa copy
                        window.open(reportUrl, '_blank');
                        
                        // Show success message
                        const toast = document.createElement('div');
                        toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
                        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
                        toast.innerHTML = `
                            <div class="d-flex">
                                <div class="toast-body">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Đã copy link và mở báo cáo!
                                </div>
                                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                            </div>
                        `;
                        document.body.appendChild(toast);
                        
                        const bsToast = new bootstrap.Toast(toast);
                        bsToast.show();
                        
                        // Remove toast after hiding
                        toast.addEventListener('hidden.bs.toast', () => {
                            document.body.removeChild(toast);
                        });
                    }).catch(function() {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = reportUrl;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        showSuccess('Đã copy link báo cáo: ' + reportUrl);
                    });
                });
            });

            initAutoSaveRanking()
        }

        // Hàm lưu nhận xét
        function saveComment(userId, showAlert = false) {
            const commentText = document.getElementById(`comment_${userId}`).value;
            const dateFrom = document.getElementById('date_from').value;
            const dateTo = document.getElementById('date_to').value;
            const statusElement = document.getElementById(`status_${userId}`);
            
            if (statusElement) {
                statusElement.className = 'save-status-dot saving';
            }
            
            fetch('/save_user_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    comment_text: commentText,
                    period_start: dateFrom,
                    period_end: dateTo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (statusElement) {
                        statusElement.className = 'save-status-dot saved';
                        setTimeout(() => {
                            statusElement.className = 'save-status-dot';
                        }, 2000);
                    }
                } else {
                    if (statusElement) {
                        statusElement.className = 'save-status-dot error';
                    }
                }
            })
            .catch(error => {
                if (statusElement) {
                    statusElement.className = 'save-status-dot error';
                }
            });
        }

        // Hàm lưu xếp loại
        function saveRanking(userId, ranking) {
            const dateFrom = document.getElementById('date_from').value;
            const dateTo = document.getElementById('date_to').value;
            const input = document.getElementById(`ranking_${userId}`);
            const rankingColor = input.getAttribute('data-ranking-color') || '';
            const statusElement = document.getElementById(`ranking_status_${userId}`);
            if (statusElement) {
                statusElement.className = 'save-status-dot saving';
            }

            fetch('/save_user_ranking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    ranking: ranking,
                    ranking_color: rankingColor,
                    period_start: dateFrom,
                    period_end: dateTo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (statusElement) {
                        statusElement.className = 'save-status-dot saved';
                        setTimeout(() => {
                            statusElement.className = 'save-status-dot';
                        }, 2000);
                    }
                } else {
                    if (statusElement) {
                        statusElement.className = 'save-status-dot error';
                    }
                }
            })
            .catch(error => {
                if (statusElement) {
                    statusElement.className = 'save-status-dot error';
                }
            });
        }

        // Auto-save functionality for comments
        function initAutoSave() {
            // Auto-save ranking on page load
            /*
            document.querySelectorAll('.auto-save-ranking').forEach(input => {
                const userId = input.dataset.userId;
                const ranking = input.value;
                
                // Auto-save ranking
                setTimeout(() => {
                    saveRanking(userId, ranking);
                }, 1000);
            });
            */
            
            // Auto-save suggested comments on page load for non-empty suggestions
            document.querySelectorAll('.auto-save-comment').forEach(textarea => {
                const userId = textarea.dataset.userId;
                const currentValue = textarea.value.trim();
                
                // If there's a suggested comment (auto-generated), save it automatically
                if (currentValue && !currentValue.includes('Nhận xét')) {
                    // Small delay to ensure page is fully loaded
                    setTimeout(() => {
                        saveComment(userId, false);
                    }, 500);
                }
                
                // Add focus out auto-save
                textarea.addEventListener('blur', function() {
                    const newValue = this.value.trim();
                    saveComment(userId, false);
                });
                
                // Optional: Add auto-save on input with debounce
                let saveTimeout;
                textarea.addEventListener('input', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveComment(userId, false);
                    }, 2000); // Auto-save 2 seconds after user stops typing
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const loadCommentsBtn = document.getElementById('loadCommentsBtn');
            loadCommentsBtn.addEventListener('click', function() {
                // Lấy danh sách user_id đang hiển thị
                document.querySelectorAll('textarea.auto-save-comment').forEach(async textarea => {
                    const userId = textarea.dataset.userId;
                    const academic_diff_points = textarea.dataset.academicPoint;
                    const conduct_diff_points = textarea.dataset.conductPoint;
                    const total_point = textarea.dataset.totalPoint;
                    const dateFrom = document.getElementById('date_from').value;
                    const dateTo = document.getElementById('date_to').value;
                    // Gọi API lấy comment
                    const res = await fetch(`/api/user_comment?user_id=${userId}&dateFrom=${dateFrom}&dateTo=${dateTo}&academic_diff_points=${academic_diff_points}&conduct_diff_points=${conduct_diff_points}&total_point=${total_point}`);
                    const data = await res.json();
                    if (data.success) {
                        textarea.value = data.comment || '';
                        textarea.readOnly = false;
                        textarea.disabled = false;
                    } else {
                        textarea.value = '';
                        textarea.readOnly = false;
                        textarea.disabled = false;
                    }
                    // Set rows=5 cho textarea
                    textarea.setAttribute('rows', 5);
                    // Gọi auto-save để lưu comment vừa fill vào DB
                    saveComment(userId, false);
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            const loadRankingBtn = document.getElementById('loadRankingBtn');
            loadRankingBtn.addEventListener('click', function() {
                document.querySelectorAll('input.auto-save-ranking').forEach(async input => {
                    const userId = input.dataset.userId;
                    const dateFrom = document.getElementById('date_from').value;
                    const dateTo = document.getElementById('date_to').value;
                    const totalPoint = input.dataset.totalPoint;
                    // Gọi API lấy ranking
                    const res = await fetch(`/api/user_ranking?user_id=${userId}&dateFrom=${dateFrom}&dateTo=${dateTo}&total_point=${totalPoint}`);
                    const data = await res.json();
                    if (data.success) {
                        input.value = data.ranking || '';
                        input.readOnly = false;
                        input.disabled = false;
                        // Set thuộc tính ranking_color vào input
                        if (data.ranking_color) {
                            input.setAttribute('data-ranking-color', data.ranking_color);
                        }
                    } else {
                        input.value = '';
                        input.readOnly = false;
                        input.disabled = false;
                        input.removeAttribute('data-ranking-color');
                    }
                    // Gọi auto-save để lưu ranking vừa fill vào DB
                    saveRanking(userId, input.value);
                });
            });
        });

        function initAutoSaveRanking() {
            document.querySelectorAll('input.auto-save-ranking').forEach(input => {
                const userId = input.dataset.userId;
                // Auto-save khi blur
                input.addEventListener('blur', function() {
                    saveRanking(userId, input.value);
                });
                // Optional: auto-save khi nhập xong (debounce)
                let saveTimeout;
                input.addEventListener('input', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        saveRanking(userId, input.value);
                    }, 2000);
                });
            });
        }
    </script>
    <style>
        @media (max-width: 768px) {
            .form-group {
                margin-bottom: 1rem;
            }

            select[multiple] {
                height: auto !important;
            }

            .btn {
                margin-bottom: 0.5rem;
            }

            .table {
                font-size: 0.7rem;
            }

            th, td {
                padding: 0.5rem !important;
            }
        }

        /* Toggle button and search form styling */
        .btn-compact {
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-compact:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-compact.btn-success {
            background: linear-gradient(135deg, #198754, #20c997);
            border: none;
            color: white;
        }

        .btn-compact.btn-warning {
            background: linear-gradient(135deg, #e0a800, #dbb43eff);
            border: none;
            color: white;
        }

        .btn-compact.btn-primary {
            background: linear-gradient(135deg, #0d6efd, #6610f2);
            border: none;
            color: white;
        }

        .btn-compact.active {
            background: linear-gradient(135deg, #6610f2, #0d6efd);
            transform: scale(1.05);
        }

        /* Search form card styling */
        .search-form-card {
            margin-bottom: 20px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .search-form-card.collapsed {
            max-height: 0;
            overflow: hidden;
            margin-bottom: 0;
            padding: 0;
            border: none;
            box-shadow: none;
        }

        .search-form-card.collapsed .card-body {
            padding: 0;
        }

        .search-form-card .card-body {
            padding: 20px;
            transition: padding 0.3s ease;
        }

        /* Animation for collapse/expand */
        @keyframes slideDown {
            from {
                max-height: 0;
                opacity: 0;
            }
            to {
                max-height: 500px;
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                max-height: 500px;
                opacity: 1;
            }
            to {
                max-height: 0;
                opacity: 0;
            }
        }

        .search-form-card.expanding {
            animation: slideDown 0.3s ease-out forwards;
        }

        .search-form-card.collapsing {
            animation: slideUp 0.3s ease-out forwards;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .d-flex.gap-2 {
                flex-wrap: wrap;
                gap: 8px !important;
            }
            
            .btn-compact {
                min-width: 40px;
            }

            .comment-col {
                min-width: 200px !important;
                max-width: 200px !important;
                width: 200px !important;
            }
        }

        .auto-save-comment {
            flex-grow: 1; /* Cho phép textarea mở rộng chiều rộng */
            width: 100%; /* Đảm bảo chiếm toàn bộ chiều rộng của container */
        }
    </style>
{% endblock %}
