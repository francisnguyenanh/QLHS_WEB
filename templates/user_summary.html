{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Thống kê học sinh</h2>

        <div class="row">
            <div class="col-md-3">
                <form method="POST" id="searchForm">
                    <!-- Chọn loại thời gian -->
                    <div class="form-group mb-3">
                        <label class="form-label">Loại thời gian:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="period_type" id="week_type" value="week" checked>
                            <label class="btn btn-outline-primary" for="week_type">Tuần</label>
                            <input type="radio" class="btn-check" name="period_type" id="month_type" value="month">
                            <label class="btn btn-outline-primary" for="month_type">Tháng</label>
                        </div>
                    </div>

                    <!-- Điều hướng thời gian -->
                    <div class="form-group mb-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" id="prevPeriod">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="text-center flex-grow-1 mx-2">
                                <strong id="periodDisplay">Tuần hiện tại</strong>
                            </div>
                            <button type="button" class="btn btn-outline-secondary" id="nextPeriod">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="date_from">Từ ngày:</label>
                        <input type="date" name="date_from" id="date_from" class="form-control" value="{{ date_from or '' }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="date_to">Đến ngày:</label>
                        <input type="date" name="date_to" id="date_to" class="form-control" value="{{ date_to or '' }}" readonly>
                    </div>
                    <div class="form-group">
                        <label for="users">Học sinh:</label>
                        <select name="users" id="users" multiple class="form-control" style="height: 80px;">
                            {% for user in all_users %}
                                <option value="{{ user[0] }}" {% if user[0]|string in selected_users %}selected{% endif %}>{{ user[1] }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="select_all_users" name="select_all_users" {% if select_all_users %}checked{% endif %}>
                            <label class="form-check-label" for="select_all_users">Chọn tất cả</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="groups">Nhóm:</label>
                        <select name="groups" id="groups" multiple class="form-control" style="height: 80px;">
                            {% for group in groups %}
                                <option value="{{ group[0] }}" {% if group[0]|string in selected_groups %}selected{% endif %}>{{ group[1] }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="select_all_groups" name="select_all_groups" {% if select_all_groups %}checked{% endif %}>
                            <label class="form-check-label" for="select_all_groups">Chọn tất cả</label>
                        </div>
                    </div>
                    <div class="form-group text-center">
                        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                    </div>
                </form>
            </div>

            <div class="col-md-9">
                <div class="d-flex justify-content-end">
                    <form method="POST" action="{{ url_for('print_users') }}" id="printForm">
                        <input type="hidden" name="selected_users" id="selected_users_input">
                        <input type="hidden" name="date_from" id="date_from_input" value="{{ date_from or '' }}">
                        <input type="hidden" name="date_to" id="date_to_input" value="{{ date_to or '' }}">
                        <button type="submit" class="btn btn-success mt-3">Xuất phiếu</button>
                    </form>
                </div>
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="select_all_in">
                                <a href="{{ url_for('user_summary', sort_by='in', sort_order='desc' if sort_by == 'in' and sort_order == 'asc' else 'asc', date_from=date_from, date_to=date_to, users=selected_users, groups=selected_groups, select_all_users=select_all_users, select_all_groups=select_all_groups) }}">
                                    Xuất
                                    {% if sort_by == 'in' %}
                                        {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('user_summary', sort_by='user_name', sort_order='desc' if sort_by == 'user_name' and sort_order == 'asc' else 'asc', date_from=date_from, date_to=date_to, users=selected_users, groups=selected_groups, select_all_users=select_all_users, select_all_groups=select_all_groups) }}">
                                    Họ tên
                                    {% if sort_by == 'user_name' %}
                                        {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="{{ url_for('user_summary', sort_by='total_points', sort_order='desc' if sort_by == 'total_points' and sort_order == 'asc' else 'asc', date_from=date_from, date_to=date_to, users=selected_users, groups=selected_groups, select_all_users=select_all_users, select_all_groups=select_all_groups) }}">
                                    Tổng điểm
                                    {% if sort_by == 'total_points' %}
                                        {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                    {% endif %}
                                </a>
                            </th>
                            <th style="width: 300px;">Nhận xét</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="in_{{ record[3] }}" value="1" {% if record[2] %}checked{% endif %}>
                                </td>
                                <td>{{ record[0] }}</td>
                                <td>{{ record[1] }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <textarea class="form-control me-2" id="comment_{{ record[3] }}" rows="2" placeholder="Nhận xét...">{{ (record[4] if record[4] else record[5]) if record|length > 4 else '' }}</textarea>
                                        <button type="button" class="btn btn-sm btn-success" onclick="saveComment({{ record[3] }})">
                                            <i class="fas fa-save"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('select_all_users').addEventListener('change', function() {
            const userSelect = document.getElementById('users');
            if (this.checked) {
                for (let i = 0; i < userSelect.options.length; i++) {
                    userSelect.options[i].selected = true;
                }
            } else {
                for (let i = 0; i < userSelect.options.length; i++) {
                    userSelect.options[i].selected = false;
                }
            }
        });

        document.getElementById('select_all_groups').addEventListener('change', function() {
            const groupSelect = document.getElementById('groups');
            if (this.checked) {
                for (let i = 0; i < groupSelect.options.length; i++) {
                    groupSelect.options[i].selected = true;
                }
            } else {
                for (let i = 0; i < groupSelect.options.length; i++) {
                    groupSelect.options[i].selected = false;
                }
            }
        });

        document.getElementById('printForm').addEventListener('submit', function(event) {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
            const selectedUserIds = Array.from(checkboxes)
                .filter(cb => cb.name.startsWith('in_'))
                .map(cb => cb.name.split('_')[1]);

            if (selectedUserIds.length === 0) {
                alert("Please select at least one user to print.");
                event.preventDefault();
                return;
            }

            document.getElementById('selected_users_input').value = selectedUserIds.join(',');
            // Đảm bảo date_from và date_to được gửi
            document.getElementById('date_from_input').value = document.getElementById('date_from').value;
            document.getElementById('date_to_input').value = document.getElementById('date_to').value;
        });

        document.getElementById('select_all_in').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('input[name^="in_"]');
            for (let i = 0; i < checkboxes.length; i++) {
                checkboxes[i].checked = this.checked;
            }
        });

        // Hàm lưu nhận xét
        function saveComment(userId) {
            const commentText = document.getElementById(`comment_${userId}`).value;
            const dateFrom = document.getElementById('date_from').value;
            const dateTo = document.getElementById('date_to').value;
            
            fetch('/save_user_comment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    comment_text: commentText,
                    period_start: dateFrom,
                    period_end: dateTo
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Đã lưu nhận xét thành công!');
                } else {
                    alert('Lỗi: ' + data.error);
                }
            })
            .catch(error => {
                alert('Lỗi kết nối: ' + error);
            });
        }

        // Hàm sử dụng gợi ý tự động
        function useAutoComment(userId, autoComment) {
            document.getElementById(`comment_${userId}`).value = autoComment;
        }

        // Biến toàn cục cho việc quản lý thời gian
        let currentDate = new Date();
        let currentPeriodType = 'week';

        // Hàm lấy thứ Hai của tuần
        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Điều chỉnh cho Chủ Nhật
            return new Date(d.setDate(diff));
        }

        // Hàm lấy ngày đầu tháng
        function getFirstDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        // Hàm lấy ngày cuối tháng
        function getLastDayOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0);
        }

        // Hàm format ngày về yyyy-mm-dd
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Hàm cập nhật hiển thị thời gian
        function updatePeriodDisplay() {
            const periodDisplay = document.getElementById('periodDisplay');
            const dateFromInput = document.getElementById('date_from');
            const dateToInput = document.getElementById('date_to');

            if (currentPeriodType === 'week') {
                const monday = getMonday(currentDate);
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);

                dateFromInput.value = formatDate(monday);
                dateToInput.value = formatDate(sunday);

                const weekNumber = getWeekNumber(monday);
                periodDisplay.textContent = `Tuần ${weekNumber} - ${monday.getFullYear()}`;
            } else {
                const firstDay = getFirstDayOfMonth(currentDate);
                const lastDay = getLastDayOfMonth(currentDate);

                dateFromInput.value = formatDate(firstDay);
                dateToInput.value = formatDate(lastDay);

                const monthNames = ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
                                   'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'];
                periodDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            }
        }

        // Hàm lấy số tuần trong năm
        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Khởi tạo
            updatePeriodDisplay();

            // Xử lý thay đổi loại thời gian
            document.querySelectorAll('input[name="period_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentPeriodType = this.value;
                    updatePeriodDisplay();
                });
            });

            // Xử lý nút lùi
            document.getElementById('prevPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    currentDate.setDate(currentDate.getDate() - 7);
                } else {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                }
                updatePeriodDisplay();
            });

            // Xử lý nút tiến
            document.getElementById('nextPeriod').addEventListener('click', function() {
                if (currentPeriodType === 'week') {
                    currentDate.setDate(currentDate.getDate() + 7);
                } else {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
                updatePeriodDisplay();
            });

            // Tự động submit form khi thay đổi ngày
            document.getElementById('date_from').addEventListener('change', function() {
                document.getElementById('searchForm').submit();
            });
            document.getElementById('date_to').addEventListener('change', function() {
                document.getElementById('searchForm').submit();
            });
        });
    </script>
{% endblock %}