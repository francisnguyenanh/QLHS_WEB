{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Danh sách lớp</h2>
        
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" class="btn btn-success w-100 w-md-auto" onclick="openCreateModal()" {% if has_existing_class %}disabled{% endif %}>
                    Tạo lớp mới
                    {% if has_existing_class %}<span class="text-muted">(Chỉ được phép có 1 lớp)</span>{% endif %}
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th class="text-nowrap">Tên lớp</th>
                        <th class="text-nowrap">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for class in classes %}
                        <tr>
                            <td>{{ class[1] }}</td>
                            <td class="text-nowrap">
                                <button class="btn btn-sm btn-primary me-1" onclick="openEditModal({{ class[0] }})">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('Bạn có chắc chắn muốn xóa lớp này?', () => deleteItem('{{ url_for('class_delete', id=class[0]) }}'))">Xoá</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Create/Edit -->
    <div class="modal fade" id="classModal" tabindex="-1" aria-labelledby="classModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="classModalLabel">Tạo lớp mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="classForm">
                        <input type="hidden" id="modal_id" name="id">
                        <div class="mb-3">
                            <label for="modal_name" class="form-label">Tên lớp:</label>
                            <input type="text" name="name" id="modal_name" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="saveClass()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let currentEditId = null;

        function openCreateModal() {
            isEditMode = false;
            currentEditId = null;
            document.getElementById('classModalLabel').textContent = 'Tạo lớp mới';
            document.getElementById('classForm').reset();
            document.getElementById('modal_id').value = '';
            const modal = new bootstrap.Modal(document.getElementById('classModal'));
            modal.show();
        }

        function openEditModal(id) {
            isEditMode = true;
            currentEditId = id;
            document.getElementById('classModalLabel').textContent = 'Chỉnh sửa lớp';
            
            // Fetch record data
            fetch(`/api/classes/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modal_id').value = data.id;
                    document.getElementById('modal_name').value = data.name;
                    
                    const modal = new bootstrap.Modal(document.getElementById('classModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching record:', error);
                    showError('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function saveClass() {
            const form = document.getElementById('classForm');
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name')
            };

            // Validate required fields
            if (!data.name) {
                showWarning('Vui lòng nhập tên lớp');
                return;
            }

            const url = isEditMode ? `/api/classes/${currentEditId}` : '/api/classes';
            const method = isEditMode ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Đóng modal trước khi hiển thị toast
                    const modal = bootstrap.Modal.getInstance(document.getElementById('classModal'));
                    if (modal) {
                        modal.hide();
                    }
                    showSuccess(result.message);
                    setTimeout(function() {
                        location.reload(); // Reload page to show updated data
                    }, 2000);
                } else {
                    showError('Có lỗi xảy ra: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving class:', error);
                showError('Có lỗi xảy ra khi lưu dữ liệu');
            });
        }

        function deleteItem(url) {
            // Hiển thị toast thành công trước
            showSuccess('Đang xóa...');
            // Delay redirect để toast hiển thị
            setTimeout(function() {
                window.location.href = url;
            }, 1000); // 1 giây để hiển thị toast "Đang xóa..."
        }
    </script>

    <style>
        @media (max-width: 768px) {
            .table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.5rem !important;
            }
            .btn {
                margin-bottom: 0.5rem;
            }
        }
    </style>
{% endblock %}