
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Cài đặt số tuần</title>
    <!-- Thêm Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <!-- Nếu cần icon/fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Thêm font tiếng Việt -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap&subset=vietnamese" rel="stylesheet">
    <style>
        body, html {
            font-family: Arial, sans-serif;
            font-size: 16px;
            background-color: #f8f9fa;
        }
        h2, h4, th, td, label, button {
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="toastMsg" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastMsgBody">
                <!-- Nội dung toast -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
<div class="container-fluid mt-3">
    <h2>Cài đặt số tuần</h2>
    <form id="weeksForm">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Số tuần</th>
                    <th>Ngày bắt đầu</th>
                    <th>Ngày kết thúc</th>
                </tr>
            </thead>
            <tbody>
                {% for week in week_data %}
                <tr>
                    <td>
                        <input type="number" class="form-control week-number" value="{{ week.week_number }}" readonly data-week="{{ week.week_number }}">
                    </td>
                    <td>
                        <input type="date" class="form-control week-from" data-week="{{ week.week_number }}" value="{{ week.from_date or '' }}">
                    </td>
                    <td>
                        <input type="date" class="form-control week-to" data-week="{{ week.week_number }}" value="{{ week.to_date or '' }}">
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="d-flex justify-content-center">
            <button type="button" class="btn btn-primary" id="registerWeeksBtn">Đăng ký</button>
        </div>
    </form>
    <script>
        function showToast(message, type='success') {
            const toastMsg = document.getElementById('toastMsg');
            const toastBody = document.getElementById('toastMsgBody');
            toastBody.textContent = message;
            toastMsg.className = 'toast align-items-center text-white border-0 bg-' + (type === 'success' ? 'success' : (type === 'error' ? 'danger' : 'warning'));
            const toast = new bootstrap.Toast(toastMsg);
            toast.show();
        }

        document.getElementById('registerWeeksBtn').onclick = function() {
            let valid = true;
            let weekSettings = [];
            document.querySelectorAll('tbody tr').forEach(function(row) {
                const weekNumber = parseInt(row.querySelector('.week-number').value);
                const fromInput = row.querySelector('.week-from');
                const toInput = row.querySelector('.week-to');
                const from = fromInput.value;
                const to = toInput.value;
                // Reset style
                row.querySelector('.week-number').classList.remove('is-invalid');
                // Nếu 1 trong 2 ngày có giá trị thì bắt buộc nhập cả 2
                if ((from && !to) || (!from && to)) {
                    valid = false;
                    row.querySelector('.week-number').classList.add('is-invalid');
                }
                // Nếu cả 2 đều có giá trị, kiểm tra from <= to
                if (from && to) {
                    if (from > to) {
                        valid = false;
                        row.querySelector('.week-number').classList.add('is-invalid');
                    } else {
                        weekSettings.push({week_number: weekNumber, from: from, to: to});
                    }
                }
                // Nếu cả 2 đều blank: không gửi lên backend
            });
            if (!valid) {
                showToast('Vui lòng kiểm tra lại các dòng tô đỏ: ngày bắt đầu phải nhỏ hơn hoặc bằng ngày kết thúc và phải nhập đủ cả 2 ngày nếu muốn đăng ký tuần.', 'error');
                return;
            }
            // Gửi dữ liệu lên backend
            fetch('/api/settings/weeks/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({week_settings: weekSettings})
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Lưu thành công!', 'success');
                    setTimeout(() => location.reload(), 1200);
                } else {
                    showToast('Lỗi: ' + (data.error || 'Không xác định'), 'error');
                }
            });
        };
    </script>
    <style>
    .is-invalid { border: 2px solid red; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
