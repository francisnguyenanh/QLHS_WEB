{% extends "base.html" %}
{% block content %}
    <div class="container">
        <h2 class="mt-4 mb-4">Danh sách kết quả</h2>
        
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="row mb-3">
            <div class="col-12">
                <button type="button" class="btn btn-success w-100 w-md-auto" onclick="openCreateModal()">Tạo mới</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th class="text-nowrap">
                            <a href="{{ url_for('criteria_list', sort_by='name', sort_order='desc' if sort_by == 'name' and sort_order == 'asc' else 'asc') }}">
                                Tên kết quả
                                {% if sort_by == 'name' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('criteria_list', sort_by='criterion_type', sort_order='desc' if sort_by == 'criterion_type' and sort_order == 'asc' else 'asc') }}">
                                Loại kết quả
                                {% if sort_by == 'criterion_type' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">
                            <a href="{{ url_for('criteria_list', sort_by='criterion_points', sort_order='desc' if sort_by == 'criterion_points' and sort_order == 'asc' else 'asc') }}">
                                Điểm kết quả
                                {% if sort_by == 'criterion_points' %}
                                    {% if sort_order == 'asc' %}▲{% else %}▼{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="text-nowrap">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for criterion in criteria %}
                        <tr>
                            <td>{{ criterion[1] }}</td>
                            <td>{{ 'Positive' if criterion[2] else 'Negative' }}</td>
                            <td>{{ criterion[3] }}</td>
                            <td class="text-nowrap">
                                <button class="btn btn-sm btn-primary me-1" onclick="openEditModal({{ criterion[0] }})">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('Bạn có chắc chắn muốn xóa kết quả học tập này?', () => deleteItem('{{ url_for('criteria_delete', id=criterion[0]) }}'))">Xoá</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Create/Edit -->
    <div class="modal fade" id="criteriaModal" tabindex="-1" aria-labelledby="criteriaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="criteriaModalLabel">Tạo kết quả học tập mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="criteriaForm">
                        <input type="hidden" id="modal_id" name="id">
                        <div class="mb-3">
                            <label for="modal_name" class="form-label">Tên kết quả:</label>
                            <input type="text" name="name" id="modal_name" class="form-control" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" name="criterion_type" id="modal_criterion_type" class="form-check-input">
                            <label class="form-check-label" for="modal_criterion_type">Tuyên dương</label>
                        </div>
                        <div class="mb-3">
                            <label for="modal_criterion_points" class="form-label">Điểm kết quả:</label>
                            <input type="number" name="criterion_points" id="modal_criterion_points" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="saveCriteria()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let currentEditId = null;

        function openCreateModal() {
            isEditMode = false;
            currentEditId = null;
            document.getElementById('criteriaModalLabel').textContent = 'Tạo kết quả học tập mới';
            document.getElementById('criteriaForm').reset();
            document.getElementById('modal_id').value = '';
            const modal = new bootstrap.Modal(document.getElementById('criteriaModal'));
            modal.show();
        }

        function openEditModal(id) {
            isEditMode = true;
            currentEditId = id;
            document.getElementById('criteriaModalLabel').textContent = 'Chỉnh sửa kết quả học tập';
            
            // Fetch record data
            fetch(`/api/criteria/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modal_id').value = data.id;
                    document.getElementById('modal_name').value = data.name;
                    document.getElementById('modal_criterion_type').checked = data.criterion_type == 1;
                    document.getElementById('modal_criterion_points').value = data.criterion_points;
                    
                    const modal = new bootstrap.Modal(document.getElementById('criteriaModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Error fetching record:', error);
                    showError('Có lỗi xảy ra khi tải dữ liệu');
                });
        }

        function saveCriteria() {
            const form = document.getElementById('criteriaForm');
            const formData = new FormData(form);
            
            const data = {
                name: formData.get('name'),
                criterion_type: document.getElementById('modal_criterion_type').checked ? 1 : 0,
                criterion_points: formData.get('criterion_points')
            };

            // Validate required fields
            if (!data.name || !data.criterion_points) {
                showWarning('Vui lòng điền đầy đủ thông tin');
                return;
            }

            const url = isEditMode ? `/api/criteria/${currentEditId}` : '/api/criteria';
            const method = isEditMode ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Đóng modal trước khi hiển thị toast
                    const modal = bootstrap.Modal.getInstance(document.getElementById('criteriaModal'));
                    if (modal) {
                        modal.hide();
                    }
                    showSuccess(result.message);
                    setTimeout(function() {
                        location.reload(); // Reload page to show updated data
                    }, 2000);
                } else {
                    showError('Có lỗi xảy ra: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving criteria:', error);
                showError('Có lỗi xảy ra khi lưu dữ liệu');
            });
        }

        function deleteItem(url) {
            // Hiển thị toast thành công trước
            showSuccess('Đang xóa...');
            // Delay redirect để toast hiển thị
            setTimeout(function() {
                window.location.href = url;
            }, 1000); // 1 giây để hiển thị toast "Đang xóa..."
        }
    </script>

    <style>
        @media (max-width: 768px) {
            .table {
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.5rem !important;
            }
            .btn {
                margin-bottom: 0.5rem;
            }
        }
    </style>
{% endblock %}